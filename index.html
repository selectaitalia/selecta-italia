<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Selecta Italia | Suite Finanziaria</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-42QMLWNCQ1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-42QMLWNCQ1', { 'debug_mode': true });
    </script>

    <style>
        :root {
            --bg-dark: #000810;
            --bg-card: #001f33;
            --accent: #d4af37; 
            --accent-dim: #8a701e;
            --text-main: #ffffff;
            --text-sec: #8aaec4;
            --success: #00e676; 
            --danger: #ff5252;
            --warning: #ffab00;
            --telegram: #229ED9;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(180deg, #001220 0%, #000000 100%); 
            margin: 0; padding: 15px; 
            color: var(--text-main);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 50px; 
        }

        .header { display: flex; justify-content: center; margin-bottom: 20px; margin-top: 10px; }
        .logo-img { width: 100%; max-width: 180px; height: auto; display: block; filter: drop-shadow(0 0 10px rgba(212,175,55,0.3)); }

        .tabs { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; font-size: 13px; cursor: pointer; border-radius: 8px; transition: all 0.3s; }
        .tab-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(212,175,55,0.4); }
        
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background-color: var(--bg-card); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); margin-bottom: 25px; border: 1px solid rgba(212, 175, 55, 0.15); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 8px; }

        .chart-controls { display: flex; gap: 5px; }
        .chart-btn { background: rgba(255,255,255,0.1); border: none; color: var(--text-sec); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .chart-btn.active { background: var(--accent); color: #000; }

        /* STEPPER */
        .stepper-container { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 5px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .step-btn { background: linear-gradient(145deg, #222, #111); border: 1px solid var(--accent-dim); color: var(--accent); width: 45px; height: 45px; border-radius: 10px; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s; user-select: none; }
        .step-btn:active { transform: scale(0.9); background: var(--accent); color: #000; }
        .step-display { flex: 1; text-align: center; font-family: 'Roboto Mono', monospace; font-size: 18px; font-weight: 700; color: #fff; display: flex; flex-direction: column; align-items: center; }
        .step-display input { background: transparent; border: none; color: #fff; text-align: center; font-size: 18px; font-weight: 700; width: 100%; outline: none; }
        .step-label { font-size: 10px; color: var(--text-sec); text-transform: uppercase; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; }

        /* TOOLTIP ICON */
        .info-icon { background: rgba(255,255,255,0.2); color: #fff; border-radius: 50%; width: 14px; height: 14px; font-size: 10px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); border: 1px solid var(--accent); border-radius: 15px; padding: 25px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-title { color: var(--accent); font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .modal-text { color: #ddd; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .modal-btn { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }

        .switch-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        .results-box { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .res-value-main { font-size: 26px; font-weight: 800; color: #fff; margin: 5px 0; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .gamification-icon { font-size: 22px; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; text-align: left; }
        .res-item-small { font-size: 11px; color: var(--text-sec); }
        .res-val-small { font-size: 14px; font-weight: 700; color: #fff; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-gold { color: var(--accent); }

        /* SHARE BUTTON */
        .share-btn {
            background: rgba(34, 158, 217, 0.2); border: 1px solid var(--telegram); color: var(--telegram);
            padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: bold;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            margin-top: 15px; cursor: pointer; transition: all 0.2s; width: 80%;
        }
        .share-btn:hover { background: var(--telegram); color: #fff; }

        .partner-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .partner-btn-gold { background: linear-gradient(45deg, #111, #222); border: 1px solid var(--accent); color: var(--accent); padding: 12px 15px; border-radius: 10px; text-decoration: none; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; margin-bottom: 8px; width: 100%; box-sizing: border-box; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; }
        .partner-btn-gold:hover { background: var(--accent); color: #000; }
        
        .chart-wrapper { position: relative; height: 220px; width: 100%; margin-top:20px; }
        
        .cta-btn { background: linear-gradient(90deg, var(--accent), #f0e68c); color: #000; width: 90%; max-width: 350px; padding: 14px; border-radius: 12px; border: none; font-size: 14px; font-weight: 800; cursor: pointer; box-shadow: 0 5px 25px rgba(212, 175, 55, 0.3); text-decoration: none; display: block; text-align: center; text-transform: uppercase; margin: 25px auto 10px auto; }
        .cta-btn:active { transform: scale(0.98); }
        .reset-link { display: block; text-align: center; margin-top: 20px; color: #555; font-size: 11px; text-decoration: underline; cursor: pointer; }
        .disclaimer { margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 10px; color: #666; text-align: justify; line-height: 1.4; border: 1px solid rgba(255,255,255,0.05); }
        .version-tag { text-align: center; font-size: 10px; color: #444; margin-top: 20px; font-family: monospace; }
        
        .tax-select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 6px; padding: 2px 5px; font-size: 12px; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <img src="1000072083.jpg" alt="SELECTA ITALIA" class="logo-img">
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('pac')">Piano Accumulo</button>
        <button class="tab-btn" onclick="openTab('rendita')">Rendita / Asset</button>
        <button class="tab-btn" onclick="openTab('confronto')">Confronto</button>
    </div>

    <div id="pac" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üìà PAC</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('pac', 'line')">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('pac', 'pie')">Torta</button>
                </div>
            </div>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-initial', -500)">-</div>
                <div class="step-display"><span class="step-label">Capitale Iniziale (‚Ç¨)</span><input type="number" id="pac-initial" value="5000" onchange="calculateAll()"></div>
                <div class="step-btn" onclick="changeVal('pac-initial', 500)">+</div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-monthly', -50)">-</div>
                <div class="step-display"><span class="step-label">Versamento Mensile (‚Ç¨)</span><input type="number" id="pac-monthly" value="400" onchange="calculateAll()"></div>
                <div class="step-btn" onclick="changeVal('pac-monthly', 50)">+</div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-years', -1)">-</div>
                <div class="step-display"><span class="step-label">Durata (Anni)</span><input type="number" id="pac-years" value="15" onchange="calculateAll()"></div>
                <div class="step-btn" onclick="changeVal('pac-years', 1)">+</div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-rate', -0.5)">-</div>
                <div class="step-display">
                    <span class="step-label">Rendimento (%) <span class="info-icon" onclick="showInfo('rate')">i</span></span>
                    <input type="number" id="pac-rate" value="8" step="0.5" onchange="calculateAll()">
                </div>
                <div class="step-btn" onclick="changeVal('pac-rate', 0.5)">+</div>
            </div>
            
             <div class="switch-container">
                <div style="font-size:12px; color:#aaa; display:flex; align-items:center; gap:5px;">
                    Calcola Inflazione (Reale) <span class="info-icon" onclick="showInfo('inflation')">i</span>
                </div>
                <label class="switch"><input type="checkbox" id="pac-inflation" onchange="calculateAll()"><span class="slider"></span></label>
            </div>
            
            <div class="stepper-container" style="margin-top:15px; padding:5px 15px;">
               <span class="step-label" style="margin-right:10px;">Costi Iniziali ‚Ç¨</span>
               <input type="number" id="pac-fees" value="0" onchange="calculateAll()" style="background:transparent; border:none; color:white; width:60px; text-align:right;">
            </div>

            <div class="results-box">
                <div style="font-size:11px; color:var(--text-sec); text-transform:uppercase;">Montante Finale Lordo</div>
                <div class="res-value-main">
                    <span id="res-pac-gross">‚Ç¨ 0</span>
                    <span id="pac-game-icon" class="gamification-icon"></span>
                </div>
                <div class="res-grid" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    <div><div class="res-item-small">Versato</div><div class="res-val-small" id="res-pac-invested">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">Guadagno</div><div class="res-val-small text-green" id="res-pac-gain">‚Ç¨ 0</div></div>
                </div>
                
                <div class="share-btn" onclick="shareTelegram('pac')">‚úàÔ∏è Condividi su Telegram</div>

                <div class="partner-section">
                    <div style="font-size:11px; color:var(--text-sec); margin-bottom:10px;">‚ö° Inizia ora il tuo PAC:</div>
                    <a href="https://refnocode.trade.re/pcbrl1pv" target="_blank" class="partner-btn-gold" 
                       onclick="gtag('event', 'click_referral', {'event_category': 'monetization', 'event_label': 'trade_republic_pac'});">
                        <span>Apri su <strong>Trade Republic</strong></span> ‚ÜóÔ∏è
                    </a>
                </div>
            </div>

            <div class="card" style="margin-top:20px; background: linear-gradient(135deg, rgba(212,175,55,0.05), rgba(0,0,0,0));">
                 <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="color:var(--accent); font-weight:bold; font-size:13px; display:flex; align-items:center; gap:5px;">
                        üîÑ Ritiro Mensile <span class="info-icon" onclick="showInfo('tax')">i</span>
                    </span>
                    <select id="pac-tax-rate" class="tax-select" onchange="calculateAll()">
                        <option value="26">26% ETF</option>
                        <option value="12.5">12.5% Bond</option>
                    </select>
                </div>
                <div class="stepper-container">
                    <div class="step-btn" onclick="changeVal('pac-withdraw-gross', -50)">-</div>
                    <div class="step-display"><span class="step-label">Prelievo Lordo (‚Ç¨)</span><input type="number" id="pac-withdraw-gross" value="0" onchange="calculateAll()"></div>
                    <div class="step-btn" onclick="changeVal('pac-withdraw-gross', 50)">+</div>
                </div>
                <div class="res-grid">
                    <div><div class="res-item-small">Netto in Tasca</div><div class="res-val-small text-green" id="res-pac-net-monthly">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">Durata</div><div class="res-val-small" style="font-size:11px;" id="res-pac-duration">---</div></div>
                </div>
            </div>

            <div class="chart-wrapper">
                <canvas id="pacChart"></canvas>
            </div>
        </div>
    </div>

    <div id="rendita" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üè† Rendita</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('ren', 'line')">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('ren', 'pie')">Torta</button>
                </div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-asset-val', -5000)">-</div>
                <div class="step-display"><span class="step-label">Valore Asset Totale (‚Ç¨)</span><input type="number" id="ren-asset-val" value="200000" onchange="calculateAll()"></div>
                <div class="step-btn" onclick="changeVal('ren-asset-val', 5000)">+</div>
            </div>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-invested', -5000)">-</div>
                <div class="step-display"><span class="step-label">Tuo Capitale Versato (‚Ç¨)</span><input type="number" id="ren-invested" value="50000" onchange="calculateAll()"></div>
                <div class="step-btn" onclick="changeVal('ren-invested', 5000)">+</div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-monthly', -50)">-</div>
                <div class="step-display"><span class="step-label">Rendita Mensile Lorda (‚Ç¨)</span><input type="number" id="ren-monthly" value="800" onchange="calculateAll()"></div>
                <div class="step-btn" onclick="changeVal('ren-monthly', 50)">+</div>
            </div>

             <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-growth', -0.5)">-</div>
                <div class="step-display"><span class="step-label">Rivalutazione Annua (%)</span><input type="number" id="ren-growth" value="1.5" step="0.5" onchange="calculateAll()"></div>
                <div class="step-btn" onclick="changeVal('ren-growth', 0.5)">+</div>
            </div>

            <div class="stepper-container" style="margin-top:10px;">
                <div class="step-btn" onclick="changeVal('ren-years', -1)">-</div>
                <div class="step-display"><span class="step-label">Proiezione Anni</span><input type="number" id="ren-years" value="15" onchange="calculateAll()"></div>
                <div class="step-btn" onclick="changeVal('ren-years', 1)">+</div>
            </div>

            <div style="margin:15px 0; display:flex; justify-content:space-between; align-items:center;">
                <label>Tassazione:</label>
                <select id="ren-tax-rate" class="tax-select" onchange="calculateAll()">
                    <option value="21">21% Cedolare</option>
                    <option value="10">10% Concordato</option>
                    <option value="26">26% Finanz.</option>
                    <option value="43">43% IRPEF</option>
                </select>
            </div>
             <div class="switch-container">
                <div style="font-size:12px; color:#aaa;">Calcola Inflazione</div>
                <label class="switch"><input type="checkbox" id="ren-inflation" onchange="calculateAll()"><span class="slider"></span></label>
            </div>

            <div class="results-box">
                <div style="font-size:11px; color:var(--text-sec);">Ricchezza Totale (Asset + Cash)</div>
                <div class="res-value-main">
                    <span id="res-ren-total-val">‚Ç¨ 0</span>
                    <span id="ren-game-icon" class="gamification-icon"></span>
                </div>

                <div class="res-grid">
                    <div><div class="res-item-small">Valore Asset</div><div class="res-val-small" id="res-ren-final-asset">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">Cash Incassato</div><div class="res-val-small text-green" id="res-ren-total-cash">‚Ç¨ 0</div></div>
                </div>
                
                <div style="margin-top:15px; display:flex; justify-content:space-around; background:rgba(255,255,255,0.05); padding:8px; border-radius:8px;">
                    <div><div class="res-item-small">ROI</div><div class="res-val-small text-gold" id="res-ren-roi">0%</div></div>
                    <div><div class="res-item-small">Netto/Mese</div><div class="res-val-small" id="res-ren-monthly-net">‚Ç¨ 0</div></div>
                </div>

                <div class="share-btn" onclick="shareTelegram('ren')">‚úàÔ∏è Condividi su Telegram</div>

                 <div class="partner-section">
                    <div style="font-size:11px; color:var(--text-sec); margin-bottom:10px;">‚ö° Ottieni il 3.75% sulla liquidit√†:</div>
                    <a href="https://refnocode.trade.re/pcbrl1pv" target="_blank" class="partner-btn-gold"
                       onclick="gtag('event', 'click_referral', {'event_category': 'monetization', 'event_label': 'trade_republic_ren'});">
                        <span>Attiva su <strong>Trade Republic</strong></span> ‚ÜóÔ∏è
                    </a>
                </div>
            </div>
            
            <div class="chart-wrapper">
                <canvas id="renChart"></canvas>
            </div>
        </div>
    </div>

    <div id="confronto" class="tab-content">
        <div class="card">
            <div class="card-title" style="margin-bottom:20px; text-align:center;">üÜö Analisi Finale</div>
            <p style="text-align:center; font-size:12px; color:var(--text-sec);">Confronto a <span id="comp-years">15</span> anni</p>

            <div class="comp-box" style="border-left: 4px solid #2979ff; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:10px;">
                <div style="font-size:12px; color:#aaa;">Strategia PAC</div>
                <div style="font-size:20px; font-weight:bold; color:#fff;" id="comp-pac-end">‚Ç¨ 0</div>
            </div>

            <div class="comp-box" style="border-left: 4px solid #d4af37; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px;">
                <div style="font-size:12px; color:#aaa;">Strategia Rendita</div>
                <div style="font-size:20px; font-weight:bold; color:#fff;" id="comp-ren-end">‚Ç¨ 0</div>
            </div>

            <div style="background:rgba(0,230,118,0.1); padding:15px; border-radius:10px; margin-top:20px; text-align:center;">
                <div class="res-item-small">VINCITORE</div>
                <div id="comp-winner-text" style="font-size:18px; font-weight:800; color:var(--success); margin-top:5px;">---</div>
            </div>
        </div>
    </div>

    <hr>
    <a href="https://t.me/selectaitalia" class="cta-btn">üíé Canale @selectaitalia</a>
    <div class="reset-link" onclick="clearData()">‚ö†Ô∏è Reset Dati</div>

    <div class="disclaimer">
        <strong>DISCLAIMER:</strong> Calcoli indicativi. Non costituiscono consulenza finanziaria.
        <br><br>¬© Selecta Italia - v1.0 Stable Release
    </div>
    
    <div style="height: 20px;"></div>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <div id="modalTitle" class="modal-title">Info</div>
            <div id="modalText" class="modal-text">Dettaglio info...</div>
            <button class="modal-btn" onclick="closeInfo()">Chiudi</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let pacChart = null;
        let renChart = null;
        let pacMode = 'line';
        let renMode = 'line';
        const fmt = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

        // --- INFO MODAL LOGIC ---
        const infoData = {
            'rate': { title: "Rendimento Atteso", text: "Il mercato azionario globale (MSCI World / S&P 500) ha storicamente reso circa il 7-9% annuo. Usa 4% per profili prudenti, 8% per aggressivi." },
            'inflation': { title: "Inflazione Reale", text: "L'inflazione (stimata al 2% annuo) riduce il potere d'acquisto. Attivando questa opzione, vedrai quanto varranno i tuoi soldi 'domani' con i prezzi di oggi." },
            'tax': { title: "Tassazione", text: "In Italia, le plusvalenze da ETF/Azioni sono tassate al 26%. I Titoli di Stato (BTP/Bond governativi) godono di aliquota agevolata al 12.5%." }
        };

        function showInfo(key) {
            const data = infoData[key];
            if(data) {
                document.getElementById('modalTitle').innerText = data.title;
                document.getElementById('modalText').innerText = data.text;
                document.getElementById('infoModal').style.display = 'flex';
            }
        }
        function closeInfo() {
            document.getElementById('infoModal').style.display = 'none';
        }

        // --- GAMIFICATION LOGIC ---
        function getGameIcon(amount) {
            if(amount < 10000) return "üõ¥"; // Monopattino
            if(amount < 30000) return "üõµ"; // Scooter
            if(amount < 100000) return "üöó"; // Auto
            if(amount < 250000) return "üèéÔ∏è"; // Supercar
            if(amount < 500000) return "üè†"; // Casa
            return "üõ•Ô∏è"; // Yacht / Libert√†
        }

        // --- SHARE LOGIC ---
        function shareTelegram(type) {
            let text = "";
            if(type === 'pac') {
                let monthly = document.getElementById('pac-monthly').value;
                let years = document.getElementById('pac-years').value;
                let total = document.getElementById('res-pac-gross').innerText;
                text = `üìä Ho appena simulato il mio Piano di Accumulo: investendo ${monthly}‚Ç¨ al mese per ${years} anni potrei ottenere ${total}! ü§Ø\n\nCalcola anche tu il tuo qui: https://t.me/SelectaHelpBot`;
            } else {
                let total = document.getElementById('res-ren-total-val').innerText;
                text = `üè† Ho simulato la mia rendita immobiliare/asset: potrei generare una ricchezza totale di ${total}! üí∞\n\nFai il calcolo qui: https://t.me/SelectaHelpBot`;
            }
            // Apre il link di condivisione Telegram
            const url = `https://t.me/share/url?url=${encodeURIComponent(text)}`;
            tg.openTelegramLink(url);
        }

        function changeVal(id, amount) {
            const input = document.getElementById(id);
            let val = parseFloat(input.value) || 0;
            let newVal = val + amount;
            if(newVal < 0) newVal = 0;
            if(amount % 1 !== 0) newVal = parseFloat(newVal.toFixed(1));
            input.value = newVal;
            calculateAll();
        }

        function setChartMode(chart, mode) {
            if(chart === 'pac') { pacMode = mode; calculatePAC(); }
            if(chart === 'ren') { renMode = mode; calculateRen(); }
            let parent = event.target.parentElement;
            parent.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function saveData() {
            const inputs = document.querySelectorAll('input, select');
            let data = {};
            inputs.forEach(el => {
                if(el.id) {
                    if(el.type === 'checkbox') data[el.id] = el.checked;
                    else data[el.id] = el.value;
                }
            });
            localStorage.setItem('selectaData_v3', JSON.stringify(data));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('selectaData_v3'));
            if(data) {
                for (const [key, value] of Object.entries(data)) {
                    const el = document.getElementById(key);
                    if(el) {
                        if(el.type === 'checkbox') el.checked = value;
                        else el.value = value;
                    }
                }
            }
        }

        function clearData() {
            if(confirm('Vuoi resettare i dati?')) {
                localStorage.removeItem('selectaData_v3');
                location.reload();
            }
        }

        function openTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'confronto') updateComparison();
        }

        function calculateAll() {
            calculatePAC();
            calculateRen();
            saveData(); 
        }

        function calculatePAC() {
            let P = parseFloat(document.getElementById('pac-initial').value) || 0;
            let PMT = parseFloat(document.getElementById('pac-monthly').value) || 0;
            let years = parseFloat(document.getElementById('pac-years').value) || 1;
            let rate = (parseFloat(document.getElementById('pac-rate').value) || 0) / 100;
            let costs = parseFloat(document.getElementById('pac-fees').value) || 0;
            let useInflation = document.getElementById('pac-inflation').checked;
            let withdrawGross = parseFloat(document.getElementById('pac-withdraw-gross').value) || 0;
            let taxRate = parseFloat(document.getElementById('pac-tax-rate').value) / 100;

            let inflationRate = useInflation ? 0.02 : 0;
            let months = years * 12;
            let monthlyRate = rate / 12;
            
            let currentTotal = P - costs;
            let currentInvested = P;

            let labels = [];
            let dataTot = [];
            let dataInv = [];

            for(let i=1; i<=months; i++){
                currentTotal = (currentTotal + PMT) * (1 + monthlyRate);
                currentInvested += PMT;
                if(i % 12 === 0) {
                     labels.push(`A${i/12}`);
                     dataTot.push(currentTotal);
                     dataInv.push(currentInvested);
                }
            }

            let grossFinal = currentTotal;
            let gainTotal = grossFinal - currentInvested;
            
            // Decumulo
            let gainRatio = (gainTotal > 0 && grossFinal > 0) ? (gainTotal / grossFinal) : 0;
            let taxAmount = (withdrawGross * gainRatio) * taxRate;
            let netWithdrawal = withdrawGross - taxAmount;
            
            let sustainabilityText = "Nessun prelievo";
            if(withdrawGross > 0) {
                 let temp = grossFinal;
                 let m = 0;
                 while(temp > 0 && m < 600) {
                     temp = temp * (1 + monthlyRate) - withdrawGross;
                     m++;
                 }
                 sustainabilityText = m >= 600 ? "> 50 Anni" : `${Math.floor(m/12)} anni, ${m%12} mesi`;
            }

            document.getElementById('res-pac-gross').innerText = fmt.format(grossFinal);
            document.getElementById('res-pac-invested').innerText = fmt.format(currentInvested);
            document.getElementById('res-pac-gain').innerText = fmt.format(gainTotal);
            document.getElementById('res-pac-net-monthly').innerText = fmt.format(netWithdrawal);
            document.getElementById('res-pac-duration').innerText = sustainabilityText;
            
            // UPDATE ICON
            document.getElementById('pac-game-icon').innerText = getGameIcon(grossFinal);

            if (pacMode === 'pie') {
                updateChart('pacChart', 'pie', ['Versato', 'Guadagno'], [currentInvested, gainTotal], ['#004d40', '#00e676']);
            } else {
                updateChart('pacChart', 'line', labels, dataTot, '#00e676');
            }
            updateComparison();
        }

        function calculateRen() {
            let Asset = parseFloat(document.getElementById('ren-asset-val').value) || 0;
            let Invested = parseFloat(document.getElementById('ren-invested').value) || 0;
            let Rent = parseFloat(document.getElementById('ren-monthly').value) || 0;
            let years = parseFloat(document.getElementById('ren-years').value) || 1;
            let growth = (parseFloat(document.getElementById('ren-growth').value) || 0) / 100;
            let tax = parseFloat(document.getElementById('ren-tax-rate').value) / 100;
            let useInflation = document.getElementById('ren-inflation').checked;
            
            let rentNet = Rent * (1 - tax);
            let currentAsset = Asset;
            let cash = 0;
            let labels = [];
            let dataWealth = [];

            for(let i=1; i<=years; i++){
                currentAsset = currentAsset * (1 + growth);
                cash += (rentNet * 12);
                labels.push(`A${i}`);
                dataWealth.push(currentAsset + cash);
            }
            
            let totalWealth = currentAsset + cash;
            if(useInflation) totalWealth = totalWealth / Math.pow(1.02, years);

            let roi = ((rentNet * 12) / Invested) * 100;

            document.getElementById('res-ren-total-val').innerText = fmt.format(totalWealth);
            document.getElementById('res-ren-final-asset').innerText = fmt.format(currentAsset);
            document.getElementById('res-ren-total-cash').innerText = fmt.format(cash);
            document.getElementById('res-ren-roi').innerText = roi.toFixed(1) + "%";
            document.getElementById('res-ren-monthly-net').innerText = fmt.format(rentNet);
            
            // UPDATE ICON
            document.getElementById('ren-game-icon').innerText = getGameIcon(totalWealth);

            if (renMode === 'pie') {
                updateChart('renChart', 'pie', ['Valore Asset', 'Cash Generato'], [currentAsset, cash], ['#8a701e', '#d4af37']);
            } else {
                updateChart('renChart', 'line', labels, dataWealth, '#d4af37');
            }
            updateComparison();
        }

        function updateComparison() {
            document.getElementById('comp-years').innerText = document.getElementById('pac-years').value;
            let vPac = parseLocaleNum(document.getElementById('res-pac-gross').innerText);
            let vRen = parseLocaleNum(document.getElementById('res-ren-total-val').innerText);
            
            document.getElementById('comp-pac-end').innerText = fmt.format(vPac);
            document.getElementById('comp-ren-end').innerText = fmt.format(vRen);
            
            let winner = vPac > vRen ? "STRATEGIA PAC üèÜ" : (vRen > vPac ? "STRATEGIA RENDITA üèÜ" : "PAREGGIO");
            document.getElementById('comp-winner-text').innerText = winner;
        }

        function parseLocaleNum(str) { return parseFloat(str.replace(/[^0-9,-]+/g,"").replace(',','.').replace('‚Ç¨','').trim()); }

        function updateChart(id, type, labels, data, colors) {
            const ctx = document.getElementById(id).getContext('2d');
            let instance = (id === 'pacChart') ? pacChart : renChart;
            if(instance) instance.destroy();

            let config = {};
            if (type === 'line') {
                config = {
                    type: 'line',
                    data: { labels: labels, datasets: [{ data: data, borderColor: colors, backgroundColor: colors + '22', fill: true, tension: 0.3, pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, interaction: { intersect: false, mode: 'index' } }
                };
            } else {
                config = {
                    type: 'doughnut',
                    data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#ccc', boxWidth: 10, font: {size: 10} } } } }
                };
            }
            let newChart = new Chart(ctx, config);
            if(id === 'pacChart') pacChart = newChart;
            else renChart = newChart;
        }

        loadData();
        calculateAll();
    </script>
</body>
</html>
