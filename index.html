<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Selecta Italia | Suite Finanziaria</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-42QMLWNCQ1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-42QMLWNCQ1', { 'debug_mode': true });
    </script>

    <style>
        :root {
            --bg-dark: #000810;
            --bg-card: #001f33;
            --accent: #d4af37; 
            --accent-dim: #8a701e;
            --text-main: #ffffff;
            --text-sec: #8aaec4;
            --success: #00e676; 
            --danger: #ff5252;
            --warning: #ffab00;
            --telegram: #229ED9;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(180deg, #001220 0%, #000000 100%); 
            margin: 0; padding: 15px; 
            color: var(--text-main);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
            user-select: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        body.loaded { opacity: 1; }

        /* HEADER */
        .header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; margin-top: 10px; }
        .logo-img { width: 140px; height: auto; display: block; filter: drop-shadow(0 0 10px rgba(212,175,55,0.3)); margin-bottom: 10px; }

        /* TABS */
        .tabs { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px 5px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; font-size: 11px; cursor: pointer; border-radius: 8px; transition: all 0.3s; white-space: nowrap; }
        .tab-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(212,175,55,0.4); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card { background-color: var(--bg-card); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); margin-bottom: 25px; border: 1px solid rgba(212, 175, 55, 0.15); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 8px; }

        /* CHART CONTROLS */
        .chart-controls { display: flex; gap: 5px; }
        .chart-btn { background: rgba(255,255,255,0.1); border: none; color: var(--text-sec); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .chart-btn.active { background: var(--accent); color: #000; }

        /* STEPPER */
        .stepper-container { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 5px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .step-btn { background: linear-gradient(145deg, #222, #111); border: 1px solid var(--accent-dim); color: var(--accent); width: 45px; height: 45px; border-radius: 10px; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s; }
        .step-btn:active { transform: scale(0.9); background: var(--accent); color: #000; }
        
        .step-display { flex: 1; text-align: center; font-family: 'Roboto Mono', monospace; font-size: 18px; font-weight: 700; color: #fff; display: flex; flex-direction: column; align-items: center; position: relative; }
        
        /* INPUT MODIFICATI PER SCRITTURA */
        .step-display input { 
            background: transparent; 
            border: 1px solid transparent; /* Bordo invisibile di base */
            color: #fff; 
            text-align: center; 
            font-size: 18px; 
            font-weight: 700; 
            width: 100%; 
            outline: none; 
            -moz-appearance: textfield; 
            border-radius: 6px;
            transition: background 0.2s, border 0.2s;
            padding: 2px;
        }
        
        /* Effetto quando clicchi per scrivere */
        .step-display input:focus {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* Rimuove le freccette standard del browser dagli input numerici */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .step-label { font-size: 10px; color: var(--text-sec); text-transform: uppercase; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; pointer-events: none; }

        /* DNA BADGE */
        .dna-badge { background: rgba(212, 175, 55, 0.2); border: 1px solid var(--accent); color: #fff; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; margin-bottom: 10px; display: inline-block; }

        /* UNIFORM ACTION BUTTONS */
        .action-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .action-btn { width: 100%; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-sizing: border-box; border: none; transition: transform 0.1s; text-decoration: none; }
        .action-btn:active { transform: scale(0.98); }
        .btn-red { background: rgba(255, 82, 82, 0.15); border: 1px solid var(--danger); color: #ff8a80; }
        .btn-red.active { background: var(--danger); color: #fff; box-shadow: 0 0 15px rgba(255, 82, 82, 0.4); }
        .btn-blue { background: rgba(34, 158, 217, 0.15); border: 1px solid var(--telegram); color: var(--telegram); }
        .btn-blue:hover { background: var(--telegram); color: #fff; }
        .btn-gold { background: linear-gradient(45deg, #111, #222); border: 1px solid var(--accent); color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-gold:hover { background: var(--accent); color: #000; }

        /* RESULTS */
        .results-box { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .res-value-main { font-size: 28px; font-weight: 800; color: #fff; margin: 10px 0; letter-spacing: 1px; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; text-align: left; }
        .res-item-small { font-size: 11px; color: var(--text-sec); }
        .res-val-small { font-size: 14px; font-weight: 700; color: #fff; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-gold { color: var(--accent); }

        /* COMMON */
        .switch-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        .chart-wrapper { position: relative; height: 220px; width: 100%; margin-top:20px; }
        .reset-link { display: block; text-align: center; margin-top: 20px; color: #555; font-size: 11px; text-decoration: underline; cursor: pointer; }
        .disclaimer { margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 10px; color: #666; text-align: justify; line-height: 1.4; border: 1px solid rgba(255,255,255,0.05); }
        
        .info-icon { background: rgba(255,255,255,0.2); color: #fff; border-radius: 50%; width: 14px; height: 14px; font-size: 10px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .info-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; font-size: 12px; color: #ccc; margin-top: 10px; border-left: 3px solid var(--accent); }

        /* CTA BTN */
        .cta-btn { display: flex; justify-content: center; align-items: center; width: 100%; padding: 16px; margin: 20px 0; background-color: var(--telegram); color: white; text-decoration: none; border-radius: 12px; font-weight: 700; font-size: 16px; box-shadow: 0 5px 15px rgba(34, 158, 217, 0.4); transition: transform 0.2s, opacity 0.2s; box-sizing: border-box; text-transform: uppercase; letter-spacing: 0.5px; }
        .cta-btn:hover { opacity: 0.9; }
        .cta-btn:active { transform: scale(0.98); }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); border: 1px solid var(--accent); border-radius: 15px; padding: 25px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-title { color: var(--accent); font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .modal-text { color: #ddd; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .modal-btn { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

    <div class="header">
        <img src="1000072083.jpg" alt="SELECTA ITALIA" class="logo-img">
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('pac')">PAC</button>
        <button class="tab-btn" onclick="openTab('rendita')">Rendita</button>
        <button class="tab-btn" onclick="openTab('tools')">Strumenti</button>
        <button class="tab-btn" onclick="openTab('confronto')">Riepilogo</button>
    </div>

    <div id="pac" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üìà PAC</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('pac', 'line')">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('pac', 'pie')">Torta</button>
                </div>
            </div>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-initial', -500)">-</div>
                <div class="step-display"><span class="step-label">Capitale Iniziale (‚Ç¨)</span><input type="number" id="pac-initial" value="5000" onchange="calculatePAC()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeVal('pac-initial', 500)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-monthly', -50)">-</div>
                <div class="step-display"><span class="step-label">Versamento Mensile (‚Ç¨)</span><input type="number" id="pac-monthly" value="400" onchange="calculatePAC()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeVal('pac-monthly', 50)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-years', -1)">-</div>
                <div class="step-display"><span class="step-label">Durata (Anni)</span><input type="number" id="pac-years" value="15" onchange="calculatePAC()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeVal('pac-years', 1)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-rate', -0.5)">-</div>
                <div class="step-display"><span class="step-label">Rendimento (%) <span class="info-icon" onclick="showInfo('rate')">i</span></span><input type="number" id="pac-rate" value="8" step="0.5" onchange="calculatePAC()" inputmode="decimal"></div>
                <div class="step-btn" onclick="changeVal('pac-rate', 0.5)">+</div>
            </div>
             <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-fees', -50)">-</div>
                <div class="step-display"><span class="step-label">Costi d'Ingresso (‚Ç¨)</span><input type="number" id="pac-fees" value="0" onchange="calculatePAC()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeVal('pac-fees', 50)">+</div>
            </div>

            <div class="switch-container">
                <div style="font-size:12px; color:#aaa; display:flex; align-items:center; gap:5px;">Calcola Inflazione <span class="info-icon" onclick="showInfo('inflation')">i</span></div>
                <label class="switch"><input type="checkbox" id="pac-inflation" onchange="calculatePAC()"><span class="slider"></span></label>
            </div>

            <div class="results-box">
                <div style="font-size:11px; color:var(--text-sec); letter-spacing:1px;">MONTANTE FINALE LORDO</div>
                <div class="res-value-main"><span id="res-pac-gross">‚Ç¨ 0</span></div>
                
                <div id="pac-dna" class="dna-badge">---</div>

                <div class="res-grid" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    <div><div class="res-item-small">Versato</div><div class="res-val-small" id="res-pac-invested">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">Guadagno</div><div class="res-val-small text-green" id="res-pac-gain">‚Ç¨ 0</div></div>
                </div>

                <div class="action-group">
                    <button class="action-btn btn-red" id="btn-crash" onclick="toggleCrash()">üí• Simula Crollo Mercati (-35%)</button>
                    <button class="action-btn btn-blue" onclick="shareTelegram('pac')">‚úàÔ∏è Condividi Analisi</button>
                    <a href="https://refnocode.trade.re/pcbrl1pv" target="_blank" class="action-btn btn-gold" onclick="gtag('event', 'click_referral', {'event_category': 'monetization', 'event_label': 'trade_republic_pac'});">‚ö° Inizia PAC su <strong>Trade Republic</strong></a>
                </div>
            </div>

            <div class="chart-wrapper"><canvas id="pacChart"></canvas></div>
        </div>
    </div>

    <div id="rendita" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üè† Rendita</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('ren', 'line')">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('ren', 'pie')">Torta</button>
                </div>
            </div>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-asset-val', -5000)">-</div>
                <div class="step-display"><span class="step-label">Valore Asset (‚Ç¨)</span><input type="number" id="ren-asset-val" value="200000" onchange="calculateRen()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeVal('ren-asset-val', 5000)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-invested', -5000)">-</div>
                <div class="step-display"><span class="step-label">Capitale Versato (‚Ç¨)</span><input type="number" id="ren-invested" value="150000" onchange="calculateRen()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeVal('ren-invested', 5000)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-monthly', -50)">-</div>
                <div class="step-display"><span class="step-label">Rendita Mensile (‚Ç¨)</span><input type="number" id="ren-monthly" value="800" onchange="calculateRen()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeVal('ren-monthly', 50)">+</div>
            </div>
             <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-years', -1)">-</div>
                <div class="step-display"><span class="step-label">Anni Proiezione</span><input type="number" id="ren-years" value="15" onchange="calculateRen()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeVal('ren-years', 1)">+</div>
            </div>
            
            <div class="results-box">
                <div style="font-size:11px; color:var(--text-sec);">RICCHEZZA TOTALE GENERATA</div>
                <div class="res-value-main" id="res-ren-total-val">‚Ç¨ 0</div>
                <div class="res-grid">
                    <div><div class="res-item-small">Valore Asset Finale</div><div class="res-val-small" id="res-ren-final-asset">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">Cash Incassato</div><div class="res-val-small text-green" id="res-ren-total-cash">‚Ç¨ 0</div></div>
                </div>
                <div class="res-grid" style="margin-top:10px; background:rgba(255,255,255,0.05); padding:8px; border-radius:8px;">
                    <div><div class="res-item-small">Capitale Iniziale</div><div class="res-val-small" id="res-ren-invested-disp">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">ROI Totale</div><div class="res-val-small text-gold" id="res-ren-roi">0%</div></div>
                </div>
                
                <div class="action-group">
                    <button class="action-btn btn-blue" onclick="shareTelegram('ren')">‚úàÔ∏è Condividi Analisi</button>
                    <a href="https://refnocode.trade.re/pcbrl1pv" target="_blank" class="action-btn btn-gold" onclick="gtag('event', 'click_referral', {'event_category': 'monetization', 'event_label': 'trade_republic_ren'});">‚ö° Ottieni 3.75% su <strong>Trade Republic</strong></a>
                </div>
            </div>
            <div class="chart-wrapper"><canvas id="renChart"></canvas></div>
        </div>
    </div>

    <div id="tools" class="tab-content">
        <div class="info-box" style="margin-bottom:20px; border-left: 3px solid #00e676;">
            <strong style="color:#fff; font-size:14px;">‚è≥ Macchina del Tempo</strong><br>
            Se avessi investito 1.000‚Ç¨ nel 2014 in <strong>S&P 500</strong>, oggi avresti circa <strong>3.200‚Ç¨</strong>.
            Se li avessi messi in <strong>Bitcoin</strong>, oggi avresti oltre <strong>120.000‚Ç¨</strong>.<br>
            <em style="font-size:10px; color:#888;">Il momento migliore per piantare un albero era 20 anni fa. Il secondo migliore √® oggi.</em>
        </div>

        <div class="card">
            <div class="card-title">üèñÔ∏è Calcolatore F.I.R.E.</div>
            <p style="font-size:12px; color:#aaa; margin:10px 0;">Obiettivo: Vivere di rendita.</p>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeFire(-50)">-</div>
                <div class="step-display"><span class="step-label">Spese Mensili (‚Ç¨)</span><input type="number" id="fire-expenses" value="1500" onchange="calcFire()" inputmode="numeric"></div>
                <div class="step-btn" onclick="changeFire(50)">+</div>
            </div>
            
            <div class="switch-container">
                <div style="font-size:12px; color:#aaa;">Considera Inflazione (20 anni)</div>
                <label class="switch"><input type="checkbox" id="fire-inflation" onchange="calcFire()"><span class="slider"></span></label>
            </div>

            <div class="results-box" style="margin-top:15px;">
                <div class="res-item-small">Capitale necessario (Regola 4%):</div>
                <div class="res-value-main" id="fire-target" style="font-size:24px; color:var(--accent);">‚Ç¨ 450.000</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">‚òï Sprechi vs Investimenti</div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeWaste(-0.5)">-</div>
                <div class="step-display"><span class="step-label">Spreco Giornaliero (‚Ç¨)</span><input type="number" id="waste-daily" value="3.5" onchange="calcWaste()" inputmode="decimal"></div>
                <div class="step-btn" onclick="changeWaste(0.5)">+</div>
            </div>
            <div class="res-grid">
                <div><div class="res-item-small">Bruciati (20 anni)</div><div class="res-val-small text-red" id="waste-result">‚Ç¨ 0</div></div>
                <div><div class="res-item-small">Investiti (8%)</div><div class="res-val-small text-green" id="waste-invested">‚Ç¨ 0</div></div>
            </div>
        </div>
    </div>

    <div id="confronto" class="tab-content">
        <div class="card">
            <div class="card-title" style="margin-bottom:20px; text-align:center;">Riepilogo Finale</div>
            <div class="comp-box" style="border-left:4px solid #00e676; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:10px;">
                <div style="font-size:12px; color:#aaa;">Strategia PAC</div>
                <div style="font-size:20px; font-weight:bold; color:#fff;" id="comp-pac-end">‚Ç¨ 0</div>
            </div>
            <div class="comp-box" style="border-left:4px solid #d4af37; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px;">
                <div style="font-size:12px; color:#aaa;">Strategia Rendita</div>
                <div style="font-size:20px; font-weight:bold; color:#fff;" id="comp-ren-end">‚Ç¨ 0</div>
            </div>
            <div style="background:rgba(0,230,118,0.1); padding:15px; border-radius:10px; margin-top:20px; text-align:center;">
                <div class="res-item-small">VINCITORE</div>
                <div id="comp-winner-text" style="font-size:18px; font-weight:800; color:var(--success); margin-top:5px;">---</div>
            </div>
        </div>
    </div>

    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 30px 0;">
    
    <a href="https://t.me/SelectaItalia" class="cta-btn" target="_blank">
        üíé Unisciti al Canale @SelectaItalia
    </a>
    
    <div class="reset-link" onclick="clearData()">‚ö†Ô∏è Reset Dati</div>
    <div class="disclaimer"><strong>DISCLAIMER:</strong> Calcoli indicativi. Non costituiscono consulenza finanziaria.<br>¬© Selecta Italia - v4.3 Polish</div>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <div id="modalTitle" class="modal-title"></div><div id="modalText" class="modal-text"></div>
            <button class="modal-btn" onclick="closeInfo()">Chiudi</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        window.addEventListener('load', () => { document.body.classList.add('loaded'); });

        let pacChart = null; let renChart = null;
        let pacMode = 'line'; let renMode = 'line';
        let crashMode = false;
        const fmt = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

        function triggerHaptic() { if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged(); }

        function changeVal(id, amount) {
            triggerHaptic();
            const input = document.getElementById(id);
            let val = parseFloat(input.value) || 0;
            let newVal = val + amount;
            if(newVal < 0) newVal = 0;
            if(amount % 1 !== 0) newVal = parseFloat(newVal.toFixed(1));
            input.value = newVal;
            
            if(id.startsWith('pac')) calculatePAC();
            else calculateRen();
        }

        function openTab(id) {
            triggerHaptic();
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'confronto') updateComparison();
        }

        function setChartMode(chart, mode) {
            triggerHaptic();
            if(chart === 'pac') { pacMode = mode; calculatePAC(); }
            if(chart === 'ren') { renMode = mode; calculateRen(); }
            let parent = event.target.parentElement;
            parent.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        // --- LOGIC ---
        let lastMilestone = 0; 

        function calculatePAC() {
            let P = parseFloat(document.getElementById('pac-initial').value) || 0;
            let PMT = parseFloat(document.getElementById('pac-monthly').value) || 0;
            let years = parseFloat(document.getElementById('pac-years').value) || 1;
            let rate = (parseFloat(document.getElementById('pac-rate').value) || 0) / 100;
            let costs = parseFloat(document.getElementById('pac-fees').value) || 0;
            let useInflation = document.getElementById('pac-inflation').checked;
            
            let months = years * 12;
            let monthlyRate = rate / 12;
            let currentTotal = P - costs;
            let currentInvested = P;
            
            let labels = []; let dataTot = []; let dataInv = [];
            let crashMonth = Math.floor(months / 2);

            for(let i=1; i<=months; i++){
                currentTotal = (currentTotal + PMT) * (1 + monthlyRate);
                currentInvested += PMT;
                if(crashMode && i === crashMonth) currentTotal = currentTotal * 0.65; 
                if(i % 12 === 0) { labels.push(`A${i/12}`); dataTot.push(currentTotal); dataInv.push(currentInvested); }
            }

            let grossFinal = currentTotal;
            if(useInflation) grossFinal = grossFinal / Math.pow(1.02, years);
            let gainTotal = grossFinal - currentInvested;

            document.getElementById('res-pac-gross').innerText = fmt.format(grossFinal);
            document.getElementById('res-pac-invested').innerText = fmt.format(currentInvested);
            document.getElementById('res-pac-gain').innerText = fmt.format(gainTotal);

            // DNA
            let dna = "üê¢ Tartaruga Saggia";
            if(rate >= 0.08) dna = "üéØ Cecchino";
            if(rate >= 0.12 || crashMode) dna = "üê∫ Lupo di Wall Street";
            document.getElementById('pac-dna').innerText = dna;

            if(grossFinal >= 100000 && lastMilestone < 100000) { confetti({particleCount: 100, spread: 70, origin: { y: 0.6 }}); lastMilestone = 100000; }
            else if(grossFinal < 100000) lastMilestone = 0; 

            let chartLabels = pacMode === 'pie' ? ['Versato', 'Guadagno'] : labels;
            let chartData1 = pacMode === 'pie' ? [currentInvested, gainTotal] : dataTot;
            let chartData2 = pacMode === 'pie' ? null : dataInv;
            let chartColors = pacMode === 'pie' ? ['#004d40', '#00e676'] : ['#00e676', '#004d40'];

            updateChart('pacChart', pacMode, chartLabels, chartData1, chartData2, chartColors);
            updateComparison();
        }

        function calculateRen() {
            let Asset = parseFloat(document.getElementById('ren-asset-val').value)||0;
            let Invested = parseFloat(document.getElementById('ren-invested').value)||0;
            let Rent = parseFloat(document.getElementById('ren-monthly').value)||0;
            let years = parseFloat(document.getElementById('ren-years').value)||1;
            
            let cash = Rent * 12 * years; 
            let total = Asset + cash; 
            
            let roi = 0;
            if (Invested > 0) roi = ((total - Invested) / Invested) * 100;

            document.getElementById('res-ren-total-val').innerText = fmt.format(total);
            document.getElementById('res-ren-final-asset').innerText = fmt.format(Asset);
            document.getElementById('res-ren-total-cash').innerText = fmt.format(cash);
            document.getElementById('res-ren-invested-disp').innerText = fmt.format(Invested);
            document.getElementById('res-ren-roi').innerText = roi.toFixed(1) + "%";
            
            let chartLabels = renMode === 'pie' ? ['Asset', 'Cash'] : ['Start', 'End'];
            let chartData1 = renMode === 'pie' ? [Asset, cash] : [Asset, total];
            let chartColors = ['#8a701e', '#d4af37'];

            updateChart('renChart', renMode, chartLabels, chartData1, null, chartColors);
            updateComparison();
        }

        function changeFire(amount) { triggerHaptic(); let inp = document.getElementById('fire-expenses'); inp.value = (parseFloat(inp.value)||0) + amount; calcFire(); }
        function calcFire() {
            let exp = parseFloat(document.getElementById('fire-expenses').value) || 0;
            let target = exp * 12 * 25; 
            let useInf = document.getElementById('fire-inflation').checked;
            if(useInf) target = target * Math.pow(1.02, 20); 
            document.getElementById('fire-target').innerText = fmt.format(target);
        }
        function changeWaste(amount) { triggerHaptic(); let inp = document.getElementById('waste-daily'); inp.value = (parseFloat(inp.value)||0) + amount; calcWaste(); }
        function calcWaste() {
            let daily = parseFloat(document.getElementById('waste-daily').value) || 0;
            let burned = daily * 365 * 20;
            let invested = daily * 365 * ((Math.pow(1.08, 20) - 1) / 0.08); 
            document.getElementById('waste-result').innerText = fmt.format(burned);
            document.getElementById('waste-invested').innerText = fmt.format(invested);
        }

        function toggleCrash() {
            triggerHaptic();
            crashMode = !crashMode;
            let btn = document.getElementById('btn-crash');
            if(crashMode) { btn.classList.add('active'); btn.innerText = "‚ö†Ô∏è CROLLO ATTIVO (-35%)"; }
            else { btn.classList.remove('active'); btn.innerText = "üí• Simula Crollo Mercati (-35%)"; }
            calculatePAC();
        }
        
        function updateComparison() {
             let pac = document.getElementById('res-pac-gross').innerText;
             let ren = document.getElementById('res-ren-total-val').innerText;
             document.getElementById('comp-pac-end').innerText = pac;
             document.getElementById('comp-ren-end').innerText = ren;
             let vPac = parseFloat(pac.replace(/[^0-9,-]+/g,"").replace(',','.'));
             let vRen = parseFloat(ren.replace(/[^0-9,-]+/g,"").replace(',','.'));
             document.getElementById('comp-winner-text').innerText = vPac > vRen ? "STRATEGIA PAC üèÜ" : (vRen > vPac ? "STRATEGIA RENDITA üèÜ" : "PAREGGIO");
        }

        function updateChart(id, mode, labels, data1, data2, colors) {
            const ctx = document.getElementById(id).getContext('2d');
            let instance = (id === 'pacChart') ? pacChart : renChart;
            if(instance) instance.destroy();

            let bg1 = colors[0];
            if(mode === 'line') {
                let gradient = ctx.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, colors[0] + '66'); 
                gradient.addColorStop(1, colors[0] + '00'); 
                bg1 = gradient;
            }

            let config;
            if(mode === 'line') {
                config = { type: 'line', data: { labels: labels, datasets: [ { data: data1, borderColor: colors[0], backgroundColor: bg1, fill: true, tension: 0.3, pointRadius: 0 }, ...(data2 ? [{ data: data2, borderColor: '#fff', borderDash:[5,5], pointRadius:0, borderWidth:1 }] : []) ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x:{display:false}, y:{display:false} }, interaction: { intersect: false, mode: 'index' } } };
            } else {
                let val1 = data2 ? data2[data2.length-1] : data1[0]; 
                let val2 = data1[data1.length-1] - val1;
                config = { type: 'doughnut', data: { labels: ['Base', 'Gain'], datasets: [{ data: [val1, val2], backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels:{color:'#fff'} } } } };
            }
            let newChart = new Chart(ctx, config);
            if(id === 'pacChart') pacChart = newChart; else renChart = newChart;
        }

        function shareTelegram(type) {
            let val = type === 'pac' ? document.getElementById('res-pac-gross').innerText : document.getElementById('res-ren-total-val').innerText;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(`üìä Ciao! Ho calcolato su Selecta Italia che potrei raggiungere ${val}! üí∞\n\nFai anche tu la simulazione qui: https://t.me/SelectaHelpBot`)}`);
        }
        
        function showInfo(k) { 
            let txt = k=='rate'?'Rendimento medio 8% (Azionario Globale).':(k=='inflation'?'Inflazione 2% annua riduce il valore futuro.':'Tasse: 26% plusvalenze.');
            document.getElementById('modalTitle').innerText = 'Info'; document.getElementById('modalText').innerText = txt; document.getElementById('infoModal').style.display = 'flex'; 
        }
        function closeInfo() { document.getElementById('infoModal').style.display = 'none'; }

        // INIT
        function clearData() {
            localStorage.removeItem('selectaData_v4');
            location.reload();
        }

        function loadData() {
            const saved = JSON.parse(localStorage.getItem('selectaData_v4'));
            if(saved) for(const [k,v] of Object.entries(saved)) { const el=document.getElementById(k); if(el) el.type==='checkbox'?el.checked=v:el.value=v; }
        }
        function saveData() {
            const inputs = document.querySelectorAll('input, select');
            let data = {};
            inputs.forEach(el => { if(el.id) { if(el.type === 'checkbox') data[el.id] = el.checked; else data[el.id] = el.value; } });
            localStorage.setItem('selectaData_v4', JSON.stringify(data));
        }
        document.addEventListener('change', saveData);
        
        loadData();
        calculatePAC(); calculateRen(); calcWaste(); calcFire();
    </script>
</body>
</html>
