<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Selecta Italia | Suite Finanziaria Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-42QMLWNCQ1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-42QMLWNCQ1');
    </script>

    <style>
        :root {
            --bg-dark: #000810;
            --bg-card: #001f33;
            --accent: #d4af37; 
            --accent-dim: #8a701e;
            --text-main: #ffffff;
            --text-sec: #8aaec4;
            --success: #00e676; 
            --danger: #ff5252;
            --warning: #ffab00;
            --telegram: #229ED9;
            --chart-blue: #1565c0;
            --chart-green: #00e676;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(180deg, #001220 0%, #000000 100%); 
            margin: 0; padding: 15px; 
            color: var(--text-main);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; 
            user-select: none;
        }

        /* HEADER & PRIVACY */
        .header { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; margin-top: 10px; position: relative; }
        .logo-img { width: 140px; height: auto; display: block; filter: drop-shadow(0 0 10px rgba(212,175,55,0.3)); }
        
        .privacy-toggle {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: 0.3s;
        }
        .privacy-toggle:active { transform: translateY(-50%) scale(0.9); }

        /* PRIVACY BLUR EFFECT */
        body.privacy-active .sensitive {
            color: transparent !important;
            text-shadow: 0 0 8px rgba(255,255,255,0.5);
            pointer-events: none; /* Previene modifica accidentale mentre nascosto */
        }
        body.privacy-active input.sensitive {
            text-shadow: 0 0 8px rgba(255,255,255,0.5);
            color: transparent;
        }

        /* TABS */
        .tabs { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .tab-btn { flex: 0 0 auto; padding: 10px 15px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; font-size: 12px; cursor: pointer; border-radius: 8px; transition: all 0.3s; }
        .tab-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(212,175,55,0.4); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card { background-color: var(--bg-card); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); margin-bottom: 25px; border: 1px solid rgba(212, 175, 55, 0.15); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 8px; }

        /* PAC MODE SWITCHER */
        .mode-switch-container { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 3px; display: flex; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .mode-btn { flex: 1; padding: 8px; text-align: center; font-size: 11px; font-weight: bold; border-radius: 8px; cursor: pointer; color: #888; transition: 0.3s; }
        .mode-btn.active { background: var(--accent); color: #000; box-shadow: 0 2px 10px rgba(212,175,55,0.2); }

        /* CONTROLS */
        .chart-controls { display: flex; gap: 5px; }
        .chart-btn { background: rgba(255,255,255,0.1); border: none; color: var(--text-sec); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .chart-btn.active { background: var(--accent); color: #000; }

        .preset-container { display: flex; gap: 8px; margin-bottom: 15px; justify-content: space-between; }
        .preset-btn { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 8px 0; border-radius: 8px; font-size: 10px; cursor: pointer; text-align: center; transition: 0.2s; }
        .preset-btn:active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* STEPPER */
        .stepper-container { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 5px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .step-btn { background: linear-gradient(145deg, #222, #111); border: 1px solid var(--accent-dim); color: var(--accent); width: 45px; height: 45px; border-radius: 10px; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s; user-select: none; }
        .step-btn:active { transform: scale(0.9); background: var(--accent); color: #000; }
        .step-display { flex: 1; text-align: center; font-family: 'Roboto Mono', monospace; font-size: 18px; font-weight: 700; color: #fff; display: flex; flex-direction: column; align-items: center; }
        .step-display input { background: transparent; border: none; color: #fff; text-align: center; font-size: 18px; font-weight: 700; width: 100%; outline: none; -moz-appearance: textfield; }
        .step-display input:focus { border-bottom: 1px solid var(--accent); }
        .step-label { font-size: 10px; color: var(--text-sec); text-transform: uppercase; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; }

        /* ACTIONS & RESULTS */
        .action-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .btn-unified { width: 100%; padding: 14px; border-radius: 10px; font-size: 13px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box; text-decoration: none; text-transform: uppercase; }
        .crash-btn { background: rgba(255, 82, 82, 0.1); border: 1px solid var(--danger); color: #ff8a80; }
        .crash-btn.active { background: var(--danger); color: #fff; }
        .share-btn { background: rgba(34, 158, 217, 0.15); border: 1px solid var(--telegram); color: var(--telegram); }
        .share-btn:hover { background: var(--telegram); color: #fff; }
        .partner-btn-gold { background: linear-gradient(45deg, #111, #222); border: 1px solid var(--accent); color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .partner-btn-gold:active { transform: scale(0.98); }

        .results-box { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .res-value-main { font-size: 28px; font-weight: 800; color: #fff; margin: 10px 0; letter-spacing: 1px; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; text-align: left; }
        .res-item-small { font-size: 11px; color: var(--text-sec); }
        .res-val-small { font-size: 14px; font-weight: 700; color: #fff; }
        
        .text-green { color: var(--success) !important; }
        .text-red { color: var(--danger) !important; }
        .text-gold { color: var(--accent) !important; }

        .switch-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        .chart-wrapper { position: relative; height: 220px; width: 100%; margin-top:20px; }
        .reset-link { display: block; text-align: center; margin-top: 20px; color: #555; font-size: 11px; text-decoration: underline; cursor: pointer; }
        .disclaimer { margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 10px; color: #666; text-align: justify; line-height: 1.4; border: 1px solid rgba(255,255,255,0.05); }
        .tax-select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 6px; padding: 5px; font-size: 14px; width: 100%; margin-bottom: 10px; }
        
        .info-icon { background: rgba(255,255,255,0.2); color: #fff; border-radius: 50%; width: 14px; height: 14px; font-size: 10px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .info-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; font-size: 12px; color: #ccc; margin-top: 10px; border-left: 3px solid var(--accent); line-height: 1.4; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); border: 1px solid var(--accent); border-radius: 15px; padding: 25px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-title { color: var(--accent); font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .modal-text { color: #ddd; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .modal-btn { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

    <div class="header">
        <img src="1000072083.jpg" alt="SELECTA ITALIA" class="logo-img">
        <div class="privacy-toggle" onclick="togglePrivacy()">üëÅÔ∏è</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('pac')">PAC</button>
        <button class="tab-btn" onclick="openTab('rendita')">Rendita</button>
        <button class="tab-btn" onclick="openTab('fisco')">Fisco</button>
        <button class="tab-btn" onclick="openTab('tools')">Tools</button>
        <button class="tab-btn" onclick="openTab('confronto')">Report</button>
    </div>

    <div id="pac" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üìà PAC</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('pac', 'line')">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('pac', 'pie')">Torta</button>
                </div>
            </div>
            
            <div class="mode-switch-container">
                <div class="mode-btn active" id="mode-proj" onclick="setPacMode('projection')">Proiezione</div>
                <div class="mode-btn" id="mode-target" onclick="setPacMode('target')">Obiettivo üéØ</div>
            </div>

            <div class="preset-container">
                <div class="preset-btn" onclick="applyPreset(4)">Prudente (4%)</div>
                <div class="preset-btn" onclick="applyPreset(8)">Bilanciato (8%)</div>
                <div class="preset-btn" onclick="applyPreset(12)">Aggressivo (12%)</div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-initial', -500)">-</div>
                <div class="step-display"><span class="step-label">Capitale Iniziale (‚Ç¨)</span><input type="number" inputmode="decimal" id="pac-initial" value="5000" class="sensitive" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-initial', 500)">+</div>
            </div>
            
            <div class="stepper-container" id="grp-monthly">
                <div class="step-btn" onclick="changeVal('pac-monthly', -50)">-</div>
                <div class="step-display"><span class="step-label">Versamento Mensile (‚Ç¨)</span><input type="number" inputmode="decimal" id="pac-monthly" value="400" class="sensitive" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-monthly', 50)">+</div>
            </div>

            <div class="stepper-container" id="grp-target" style="display:none; border-color:var(--accent);">
                <div class="step-btn" onclick="changeVal('pac-target-val', -5000)">-</div>
                <div class="step-display"><span class="step-label text-gold">Obiettivo Finale (‚Ç¨)</span><input type="number" inputmode="decimal" id="pac-target-val" value="100000" class="sensitive" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-target-val', 5000)">+</div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-years', -1)">-</div>
                <div class="step-display"><span class="step-label">Durata (Anni)</span><input type="number" inputmode="decimal" id="pac-years" value="15" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-years', 1)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-rate', -0.5)">-</div>
                <div class="step-display"><span class="step-label">Rendimento (%)</span><input type="number" inputmode="decimal" id="pac-rate" value="8" step="0.5" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-rate', 0.5)">+</div>
            </div>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-fees', -50)">-</div>
                <div class="step-display"><span class="step-label">Costi d'Ingresso (‚Ç¨)</span><input type="number" inputmode="decimal" id="pac-fees" value="0" class="sensitive" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-fees', 50)">+</div>
            </div>

            <div class="switch-container">
                <div style="font-size:12px; color:#aaa;">Calcola Inflazione</div>
                <label class="switch"><input type="checkbox" id="pac-inflation" onchange="calculatePAC()"><span class="slider"></span></label>
            </div>

            <div class="results-box">
                <div style="font-size:11px; color:var(--text-sec); letter-spacing:1px;" id="res-pac-label">MONTANTE FINALE LORDO</div>
                <div class="res-value-main sensitive"><span id="res-pac-gross">‚Ç¨ 0</span></div>
                
                <div class="res-grid" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    <div><div class="res-item-small" id="lbl-invested">Versato</div><div class="res-val-small sensitive" id="res-pac-invested">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small" id="lbl-gain">Guadagno</div><div class="res-val-small text-green sensitive" id="res-pac-gain">‚Ç¨ 0</div></div>
                </div>
                <div class="action-group">
                    <div class="btn-unified crash-btn" id="btn-crash" onclick="toggleCrash()">üí• Simula Crollo Mercati (-35%)</div>
                    <div class="btn-unified share-btn" onclick="shareTelegram('pac')">‚úàÔ∏è Condividi Analisi</div>
                    <a href="https://refnocode.trade.re/pcbrl1pv" target="_blank" class="btn-unified partner-btn-gold" onclick="gtag('event', 'click_referral', {'event_category': 'monetization', 'event_label': 'trade_republic_pac'});">‚ö° Inizia PAC su <strong>Trade Republic</strong></a>
                </div>
            </div>
            <div class="chart-wrapper"><canvas id="pacChart"></canvas></div>
        </div>
    </div>

    <div id="rendita" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üè† Rendita</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('ren', 'line')">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('ren', 'pie')">Torta</button>
                </div>
            </div>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-asset-val', -5000)">-</div>
                <div class="step-display"><span class="step-label">Valore Asset (‚Ç¨)</span><input type="number" inputmode="decimal" id="ren-asset-val" value="200000" class="sensitive" onchange="calculateRen()"></div>
                <div class="step-btn" onclick="changeVal('ren-asset-val', 5000)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-invested', -5000)">-</div>
                <div class="step-display"><span class="step-label">Capitale Versato (‚Ç¨)</span><input type="number" inputmode="decimal" id="ren-invested" value="150000" class="sensitive" onchange="calculateRen()"></div>
                <div class="step-btn" onclick="changeVal('ren-invested', 5000)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-monthly', -50)">-</div>
                <div class="step-display"><span class="step-label">Rendita Mensile (‚Ç¨)</span><input type="number" inputmode="decimal" id="ren-monthly" value="800" class="sensitive" onchange="calculateRen()"></div>
                <div class="step-btn" onclick="changeVal('ren-monthly', 50)">+</div>
            </div>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-growth', -0.5)">-</div>
                <div class="step-display"><span class="step-label">Rivalutazione Annua (%)</span><input type="number" inputmode="decimal" id="ren-growth" value="2" step="0.5" onchange="calculateRen()"></div>
                <div class="step-btn" onclick="changeVal('ren-growth', 0.5)">+</div>
            </div>

             <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('ren-years', -1)">-</div>
                <div class="step-display"><span class="step-label">Anni Proiezione</span><input type="number" inputmode="decimal" id="ren-years" value="15" onchange="calculateRen()"></div>
                <div class="step-btn" onclick="changeVal('ren-years', 1)">+</div>
            </div>
            
            <div class="switch-container">
                <div style="font-size:12px; color:#aaa;">Calcola Inflazione</div>
                <label class="switch"><input type="checkbox" id="ren-inflation" onchange="calculateRen()"><span class="slider"></span></label>
            </div>

            <div class="results-box">
                <div style="font-size:11px; color:var(--text-sec);">RICCHEZZA TOTALE GENERATA</div>
                <div class="res-value-main sensitive" id="res-ren-total-val">‚Ç¨ 0</div>
                <div class="res-grid">
                    <div><div class="res-item-small">Valore Asset Finale</div><div class="res-val-small sensitive" id="res-ren-final-asset">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">Rendita Totale</div><div class="res-val-small text-green sensitive" id="res-ren-total-cash">‚Ç¨ 0</div></div>
                </div>
                <div class="res-grid" style="margin-top:10px; background:rgba(255,255,255,0.05); padding:8px; border-radius:8px;">
                    <div><div class="res-item-small">Capitale Versato</div><div class="res-val-small sensitive" id="res-ren-invested-disp">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">ROI Totale</div><div class="res-val-small text-gold" id="res-ren-roi">0%</div></div>
                </div>
                <div class="action-group">
                    <div class="btn-unified share-btn" onclick="shareTelegram('ren')">‚úàÔ∏è Condividi Analisi</div>
                    <a href="https://refnocode.trade.re/pcbrl1pv" target="_blank" class="btn-unified partner-btn-gold" onclick="gtag('event', 'click_referral', {'event_category': 'monetization', 'event_label': 'trade_republic_ren'});">‚ö° Ottieni 3.75% su <strong>Trade Republic</strong></a>
                </div>
            </div>
            <div class="chart-wrapper"><canvas id="renChart"></canvas></div>
        </div>
    </div>

    <div id="fisco" class="tab-content">
        <div class="card">
            <div class="card-title">‚öñÔ∏è Calcolatore Netto</div>
            <p style="font-size:12px; color:#aaa; margin-bottom:15px;">Scopri quanto ti rimane realmente in tasca.</p>
            
            <select id="fisco-type" class="tax-select" onchange="calculateFisco()">
                <option value="26">Azioni / ETF / Crypto (26%)</option>
                <option value="12.5">Titoli di Stato / Bond (12.5%)</option>
            </select>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('fisco-gain', -100)">-</div>
                <div class="step-display"><span class="step-label">Guadagno Lordo (‚Ç¨)</span><input type="number" inputmode="decimal" id="fisco-gain" value="1000" class="sensitive" onchange="calculateFisco()"></div>
                <div class="step-btn" onclick="changeVal('fisco-gain', 100)">+</div>
            </div>
            
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('fisco-capital', -1000)">-</div>
                <div class="step-display"><span class="step-label">Capitale Investito Totale (‚Ç¨)</span><input type="number" inputmode="decimal" id="fisco-capital" value="10000" class="sensitive" onchange="calculateFisco()"></div>
                <div class="step-btn" onclick="changeVal('fisco-capital', 1000)">+</div>
            </div>

            <div class="switch-container">
                <div style="font-size:12px; color:#aaa;">Applica Bollo (0.2% IVAFE/anno)</div>
                <label class="switch"><input type="checkbox" id="fisco-bollo" onchange="calculateFisco()"><span class="slider"></span></label>
            </div>

            <div class="results-box">
                <div class="res-item-small">NETTO IN TASCA</div>
                <div class="res-value-main text-green sensitive" id="res-fisco-net">‚Ç¨ 0</div>
                <div class="res-grid">
                    <div><div class="res-item-small">Tasse (Capital Gain)</div><div class="res-val-small text-red sensitive" id="res-fisco-tax">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small">Bollo (Stima 1 anno)</div><div class="res-val-small text-warning sensitive" id="res-fisco-stamp">‚Ç¨ 0</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tools" class="tab-content">
        <div class="card">
            <div class="card-title">üèñÔ∏è F.I.R.E. Countdown</div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeFire('fire-expenses', -50)">-</div>
                <div class="step-display"><span class="step-label">Spese Mensili (‚Ç¨)</span><input type="number" inputmode="decimal" id="fire-expenses" value="1500" class="sensitive" onchange="calcFire()"></div>
                <div class="step-btn" onclick="changeFire('fire-expenses', 50)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeFire('fire-current', -1000)">-</div>
                <div class="step-display"><span class="step-label">Capitale Attuale (‚Ç¨)</span><input type="number" inputmode="decimal" id="fire-current" value="10000" class="sensitive" onchange="calcFire()"></div>
                <div class="step-btn" onclick="changeFire('fire-current', 1000)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeFire('fire-savings', -50)">-</div>
                <div class="step-display"><span class="step-label">Risparmio Mensile (‚Ç¨)</span><input type="number" inputmode="decimal" id="fire-savings" value="500" class="sensitive" onchange="calcFire()"></div>
                <div class="step-btn" onclick="changeFire('fire-savings', 50)">+</div>
            </div>
            <div class="results-box">
                <div class="res-item-small">Obiettivo: <span id="fire-goal-val" class="sensitive">‚Ç¨ 450.000</span></div>
                <div class="res-value-main" id="fire-time" style="font-size:22px; color:var(--accent);">Calcolo...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">‚è≥ Backtest Reale (10 Anni)</div>
            <p style="font-size:11px; color:#aaa;">Se avessi investito nel 2016...</p>
            <select id="backtest-asset" class="tax-select" onchange="calcBacktest()">
                <option value="sp500">üá∫üá∏ S&P 500 (+220%)</option>
                <option value="btc">‚Çø Bitcoin (+5000%)</option>
                <option value="gold">ü•á Oro (+90%)</option>
            </select>
            <input type="number" inputmode="decimal" id="backtest-amount" value="1000" class="tax-select sensitive" style="text-align:center; font-weight:bold; color:#fff;" onchange="calcBacktest()">
            <div class="results-box">
                <div class="res-item-small">Oggi avresti:</div>
                <div class="res-value-main sensitive" id="backtest-result">‚Ç¨ 3.200</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üÜö Lump Sum vs PAC</div>
            <div class="stepper-container">
                <div class="step-display"><span class="step-label">Capitale Totale (‚Ç¨)</span><input type="number" inputmode="decimal" id="lump-total" value="12000" class="sensitive" onchange="calcLump()"></div>
            </div>
            <div class="res-grid">
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                    <div class="res-item-small">SUBITO (Lump Sum)</div>
                    <div class="res-val-small text-green sensitive" id="res-lump">‚Ç¨ 0</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                    <div class="res-item-small">A RATE (PAC 24 mesi)</div>
                    <div class="res-val-small sensitive" id="res-lump-pac">‚Ç¨ 0</div>
                </div>
            </div>
            <div style="font-size:10px; color:#666; text-align:center; margin-top:5px;">Calcolato su 10 anni al 7% annuo</div>
        </div>
    </div>

    <div id="confronto" class="tab-content">
        <div class="card">
            <div class="card-title" style="margin-bottom:20px; text-align:center;">Analisi Finale</div>
            <div class="comp-box" style="border-left:4px solid #00e676; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:10px;">
                <div style="font-size:12px; color:#aaa;">Strategia PAC</div>
                <div style="font-size:20px; font-weight:bold; color:#fff;" id="comp-pac-end" class="sensitive">‚Ç¨ 0</div>
            </div>
            <div class="comp-box" style="border-left:4px solid #d4af37; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px;">
                <div style="font-size:12px; color:#aaa;">Strategia Rendita</div>
                <div style="font-size:20px; font-weight:bold; color:#fff;" id="comp-ren-end" class="sensitive">‚Ç¨ 0</div>
            </div>
            <div class="comp-box" style="border-left:4px solid #1565c0; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px;">
                <div style="font-size:12px; color:#aaa;">Strategia Lump Sum</div>
                <div style="font-size:20px; font-weight:bold; color:#fff;" id="comp-lump-end" class="sensitive">‚Ç¨ 0</div>
            </div>
            <div style="background:rgba(0,230,118,0.1); padding:15px; border-radius:10px; margin-top:20px; text-align:center;">
                <div class="res-item-small">VINCITORE MATEMATICO</div>
                <div id="comp-winner-text" style="font-size:18px; font-weight:800; color:var(--success); margin-top:5px;">---</div>
            </div>
        </div>
    </div>

    <hr>
    <a href="https://t.me/selectaitalia" class="btn-unified partner-btn-gold" style="margin-top:30px; background:linear-gradient(45deg, #222, #333); border:1px solid #d4af37; color:#fff; text-transform:none;">üíé Unisciti al Canale @selectaitalia</a>
    
    <div class="reset-link" onclick="clearData()">‚ö†Ô∏è Reset Dati</div>
    <div class="disclaimer"><strong>DISCLAIMER:</strong> Calcoli indicativi. Non costituiscono consulenza finanziaria.<br>¬© Selecta Italia - v7.0 Masterpiece</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let pacChart = null; let renChart = null;
        let pacMode = 'line'; let renMode = 'line';
        let pacCalcMode = 'projection'; // 'projection' or 'target'
        let crashMode = false;
        let isPrivacy = false;
        const fmt = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

        // --- HAPTICS & UI ---
        function triggerHaptic() { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }

        function togglePrivacy() {
            triggerHaptic();
            isPrivacy = !isPrivacy;
            document.body.classList.toggle('privacy-active');
        }

        function changeVal(id, amount) {
            triggerHaptic();
            const input = document.getElementById(id);
            let val = parseFloat(input.value) || 0;
            let newVal = val + amount;
            if(newVal < 0) newVal = 0;
            if(amount % 1 !== 0) newVal = parseFloat(newVal.toFixed(1));
            input.value = newVal;
            calculateAll();
        }

        function changeFire(id, amount) {
            triggerHaptic();
            const input = document.getElementById(id);
            input.value = (parseFloat(input.value)||0) + amount;
            calcFire();
        }

        function applyPreset(rate) {
            triggerHaptic();
            document.getElementById('pac-rate').value = rate;
            calculatePAC();
        }

        function openTab(id) {
            triggerHaptic();
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'confronto') updateComparison();
        }

        function setChartMode(chart, mode) {
            triggerHaptic();
            if(chart === 'pac') { pacMode = mode; calculatePAC(); }
            if(chart === 'ren') { renMode = mode; calculateRen(); }
            let parent = event.target.parentElement;
            parent.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setPacMode(mode) {
            triggerHaptic();
            pacCalcMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(mode === 'projection' ? 'mode-proj' : 'mode-target').classList.add('active');
            
            // Toggle Inputs
            document.getElementById('grp-monthly').style.display = mode === 'projection' ? 'flex' : 'none';
            document.getElementById('grp-target').style.display = mode === 'target' ? 'flex' : 'none';
            
            // Toggle Output Labels
            document.getElementById('res-pac-label').innerText = mode === 'projection' ? "MONTANTE FINALE LORDO" : "VERSAMENTO MENSILE NECESSARIO";
            document.getElementById('lbl-gain').innerText = mode === 'projection' ? "Guadagno" : "Interessi Totali";
            
            calculatePAC();
        }

        function calculateAll() {
            calculatePAC(); calculateRen(); calculateFisco(); calcFire(); calcBacktest(); calcLump();
        }

        function setDynamicColor(elemId, value, threshold = 0) {
            const el = document.getElementById(elemId);
            if(value < threshold) {
                el.classList.remove('text-green', 'text-gold');
                el.classList.add('text-red');
            } else {
                el.classList.remove('text-red');
                el.classList.add('text-green');
            }
        }

        // --- LOGIC PAC (DUAL MODE) ---
        function calculatePAC() {
            let P = parseFloat(document.getElementById('pac-initial').value) || 0;
            let years = parseFloat(document.getElementById('pac-years').value) || 1;
            let rate = (parseFloat(document.getElementById('pac-rate').value) || 0) / 100;
            let costs = parseFloat(document.getElementById('pac-fees').value) || 0;
            let useInflation = document.getElementById('pac-inflation').checked;
            
            let months = years * 12;
            let monthlyRate = rate / 12;
            let currentTotal = P - costs;
            let currentInvested = P;
            
            let labels = []; let dataTot = []; let dataInv = [];
            let crashMonth = Math.floor(months / 2);
            
            let PMT = 0;
            let calculatedMonthly = 0;

            if (pacCalcMode === 'projection') {
                PMT = parseFloat(document.getElementById('pac-monthly').value) || 0;
                calculatedMonthly = PMT;
                
                // STANDARD LOOP
                for(let i=1; i<=months; i++){
                    currentTotal = (currentTotal + PMT) * (1 + monthlyRate);
                    currentInvested += PMT;
                    if(crashMode && i === crashMonth) currentTotal = currentTotal * 0.65; 
                    labels.push(i); dataTot.push(currentTotal); dataInv.push(currentInvested);
                }
                
                let grossFinal = currentTotal;
                if(useInflation) grossFinal = grossFinal / Math.pow(1.02, years);
                let gainTotal = grossFinal - currentInvested;

                document.getElementById('res-pac-gross').innerText = fmt.format(grossFinal);
                document.getElementById('res-pac-invested').innerText = fmt.format(currentInvested);
                document.getElementById('res-pac-gain').innerText = fmt.format(gainTotal);
                setDynamicColor('res-pac-gain', gainTotal, 0);

                if (pacMode === 'pie') updateChart('pacChart', 'pie', ['Capitale', 'Guadagno'], [currentInvested, gainTotal], null, ['#1565c0', '#00e676']);
                else updateChart('pacChart', 'line', labels, dataTot, dataInv, ['#00e676', '#1565c0']);

            } else {
                // TARGET MODE
                let Target = parseFloat(document.getElementById('pac-target-val').value) || 0;
                
                // Formula Inverse: PMT = (Target - P(1+r)^n) / ( ((1+r)^n - 1) / r )
                // Using monthly compounding
                let FV_Initial = (P - costs) * Math.pow(1 + monthlyRate, months);
                let Remainder = Target - FV_Initial;
                
                if (Remainder <= 0) {
                    calculatedMonthly = 0; 
                } else {
                    let GeometricSeries = (Math.pow(1 + monthlyRate, months) - 1) / monthlyRate;
                    calculatedMonthly = Remainder / GeometricSeries;
                }
                
                // Re-run simulation for chart
                PMT = calculatedMonthly;
                currentTotal = P - costs;
                currentInvested = P;
                
                for(let i=1; i<=months; i++){
                    currentTotal = (currentTotal + PMT) * (1 + monthlyRate);
                    currentInvested += PMT;
                    labels.push(i); dataTot.push(currentTotal); dataInv.push(currentInvested);
                }

                // Display Results
                document.getElementById('res-pac-gross').innerText = fmt.format(calculatedMonthly) + " / mese";
                document.getElementById('res-pac-invested').innerText = fmt.format(currentInvested);
                document.getElementById('res-pac-gain').innerText = fmt.format(currentTotal - currentInvested);
                
                if (pacMode === 'pie') updateChart('pacChart', 'pie', ['Capitale', 'Interessi'], [currentInvested, currentTotal - currentInvested], null, ['#1565c0', '#00e676']);
                else updateChart('pacChart', 'line', labels, dataTot, dataInv, ['#00e676', '#1565c0']);
            }
            updateComparison();
        }

        // --- LOGIC RENDITA ---
        function calculateRen() {
            let Asset = parseFloat(document.getElementById('ren-asset-val').value)||0;
            let Invested = parseFloat(document.getElementById('ren-invested').value)||0;
            let Rent = parseFloat(document.getElementById('ren-monthly').value)||0;
            let years = parseFloat(document.getElementById('ren-years').value)||1;
            let growth = (parseFloat(document.getElementById('ren-growth').value)||0) / 100;
            let useInflation = document.getElementById('ren-inflation').checked;
            
            let months = years * 12;
            let currentAsset = Asset;
            let cashTotal = 0;
            let monthlyGrowth = growth / 12;
            
            let labels = []; let dataTotal = [];
            
            for(let i=1; i<=months; i++){
                currentAsset = currentAsset * (1 + monthlyGrowth); 
                cashTotal += Rent; 
                labels.push(i);
                dataTotal.push(currentAsset + cashTotal);
            }

            let total = currentAsset + cashTotal;
            if(useInflation) total = total / Math.pow(1.02, years);

            let roi = 0; if (Invested > 0) roi = ((total - Invested) / Invested) * 100;

            document.getElementById('res-ren-total-val').innerText = fmt.format(total);
            document.getElementById('res-ren-final-asset').innerText = fmt.format(currentAsset);
            document.getElementById('res-ren-total-cash').innerText = fmt.format(cashTotal);
            document.getElementById('res-ren-invested-disp').innerText = fmt.format(Invested);
            document.getElementById('res-ren-roi').innerText = roi.toFixed(1) + "%";
            
            setDynamicColor('res-ren-total-val', total - Invested, 0);
            setDynamicColor('res-ren-roi', roi, 0);

            let totalGain = total - Invested; if(totalGain < 0) totalGain = 0;

            if (renMode === 'pie') updateChart('renChart', 'pie', ['Capitale Versato', 'Guadagno Totale'], [Invested, totalGain], null, ['#1565c0', '#00e676']);
            else updateChart('renChart', 'line', labels, dataTotal, null, ['#00e676']);
            updateComparison();
        }

        // --- LOGIC FISCO ---
        function calculateFisco() {
            let type = parseFloat(document.getElementById('fisco-type').value);
            let gain = parseFloat(document.getElementById('fisco-gain').value)||0;
            let capital = parseFloat(document.getElementById('fisco-capital').value)||0;
            let useBollo = document.getElementById('fisco-bollo').checked;

            let tax = gain * (type / 100);
            let stamp = useBollo ? (capital * 0.002) : 0; 
            let net = gain - tax - stamp;

            document.getElementById('res-fisco-net').innerText = fmt.format(net);
            document.getElementById('res-fisco-tax').innerText = fmt.format(tax);
            document.getElementById('res-fisco-stamp').innerText = fmt.format(stamp);
        }

        // --- LOGIC TOOLS ---
        function calcFire() {
            let expenses = parseFloat(document.getElementById('fire-expenses').value)||0;
            let current = parseFloat(document.getElementById('fire-current').value)||0;
            let savings = parseFloat(document.getElementById('fire-savings').value)||0;
            
            let target = expenses * 12 * 25; 
            document.getElementById('fire-goal-val').innerText = fmt.format(target);

            let rate = 0.07 / 12; 
            let months = 0;
            let simCapital = current;
            
            while(simCapital < target && months < 600) {
                simCapital = (simCapital * (1 + rate)) + savings;
                months++;
            }
            
            let years = Math.floor(months / 12);
            let m = months % 12;
            document.getElementById('fire-time').innerText = months >= 600 ? "> 50 Anni" : `${years} Anni e ${m} Mesi`;
        }

        function calcBacktest() {
            let asset = document.getElementById('backtest-asset').value;
            let amount = parseFloat(document.getElementById('backtest-amount').value)||0;
            let mult = 1;
            if(asset === 'sp500') mult = 3.2;
            if(asset === 'btc') mult = 50; 
            if(asset === 'gold') mult = 1.9;
            document.getElementById('backtest-result').innerText = fmt.format(amount * mult);
        }

        function calcLump() {
            let P = parseFloat(document.getElementById('lump-total').value)||0;
            let r = 0.07; 
            let t = 10;
            let lump = P * Math.pow(1+r, t);
            let monthly = P / 24; 
            let pacTotal = 0; 
            let monthlyRate = r/12;
            for(let i=0; i<24; i++) { pacTotal = (pacTotal + monthly) * (1 + monthlyRate); }
            pacTotal = pacTotal * Math.pow(1+monthlyRate, 96);

            document.getElementById('res-lump').innerText = fmt.format(lump);
            document.getElementById('res-lump-pac').innerText = fmt.format(pacTotal);
            document.getElementById('comp-lump-end').innerText = fmt.format(lump);
            updateComparison();
        }

        // --- SHARED & CHARTS ---
        function toggleCrash() {
            triggerHaptic();
            crashMode = !crashMode;
            let btn = document.getElementById('btn-crash');
            if(crashMode) { btn.classList.add('active'); btn.innerText = "‚ö†Ô∏è CROLLO ATTIVO (-35%)"; }
            else { btn.classList.remove('active'); btn.innerText = "üí• Simula Crollo Mercati (-35%)"; }
            calculatePAC();
        }
        
        function updateComparison() {
             let pacText = document.getElementById('res-pac-gross').innerText;
             // Handle " / mese" in target mode for comparison logic (use raw total if possible, otherwise skip)
             if(pacText.includes('/ mese')) {
                 // In target mode, comparison is tricky. Let's use Invested + Gain
                 let invested = parseFloat(document.getElementById('res-pac-invested').innerText.replace(/[^0-9,-]+/g,"").replace(',','.'));
                 let gain = parseFloat(document.getElementById('res-pac-gain').innerText.replace(/[^0-9,-]+/g,"").replace(',','.'));
                 var pac = invested + gain;
             } else {
                 var pac = parseFloat(pacText.replace(/[^0-9,-]+/g,"").replace(',','.'));
             }

             let ren = parseFloat(document.getElementById('res-ren-total-val').innerText.replace(/[^0-9,-]+/g,"").replace(',','.'));
             let lump = parseFloat(document.getElementById('res-lump').innerText.replace(/[^0-9,-]+/g,"").replace(',','.'));
             
             document.getElementById('comp-pac-end').innerText = fmt.format(pac);
             document.getElementById('comp-ren-end').innerText = fmt.format(ren);
             
             let winner = "PAC";
             let max = pac;
             if(ren > max) { max = ren; winner = "RENDITA"; }
             if(lump > max) { max = lump; winner = "LUMP SUM (SUBITO)"; }
             
             document.getElementById('comp-winner-text').innerText = `${winner} üèÜ`;
        }

        function updateChart(id, mode, labels, data1, data2, colors) {
            const ctx = document.getElementById(id).getContext('2d');
            let instance = (id === 'pacChart') ? pacChart : renChart;
            if(instance) instance.destroy();

            let config;
            if(mode === 'line') {
                config = { 
                    type: 'line', 
                    data: { 
                        labels: labels, 
                        datasets: [ 
                            { 
                                label: 'Totale',
                                data: data1, 
                                borderColor: colors[0], 
                                backgroundColor: colors[0]+'33', 
                                fill: true, 
                                tension: 0.3, 
                                pointRadius: 0,
                                pointHoverRadius: 6 
                            }, 
                            ...(data2 ? [{ 
                                label: 'Investito',
                                data: data2, 
                                borderColor: colors[1], 
                                borderDash:[5,5], 
                                pointRadius:0, 
                                borderWidth:1 
                            }] : []) 
                        ] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, 
                        scales: { x:{display:false}, y:{display:false} }, 
                        interaction: { intersect: false, mode: 'index' } 
                    } 
                };
            } else {
                let finalData = data1; 
                config = { type: 'doughnut', data: { labels: labels, datasets: [{ data: finalData, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels:{color:'#fff'} } } } };
            }
            let newChart = new Chart(ctx, config);
            if(id === 'pacChart') pacChart = newChart; else renChart = newChart;
        }

        function shareTelegram(type) {
            let val = document.getElementById('res-pac-gross').innerText;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(`üìä Analisi Selecta Italia: ${val}!\nCalcola qui: https://t.me/SelectaHelpBot`)}`);
        }
        
        // AUTO-SAVE SYSTEM
        const saved = JSON.parse(localStorage.getItem('selectaData_v7'));
        if(saved) for(const [k,v] of Object.entries(saved)) { 
            const el=document.getElementById(k); 
            if(el) el.type==='checkbox'?el.checked=v:el.value=v; 
        }
        
        document.querySelectorAll('input, select').forEach(el => el.addEventListener('change', () => {
            const inputs = document.querySelectorAll('input, select');
            let data = {};
            inputs.forEach(el => { if(el.id) { if(el.type === 'checkbox') data[el.id] = el.checked; else data[el.id] = el.value; } });
            localStorage.setItem('selectaData_v7', JSON.stringify(data));
        }));

        function clearData() {
            if(confirm('Vuoi resettare i dati?')) { localStorage.removeItem('selectaData_v7'); location.reload(); }
        }

        // INITIAL CALC
        calculateAll();
    </script>
</body>
</html>
