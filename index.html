<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Selecta Italia | v10.5 Final</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #000810;
            --bg-card: #001f33;
            --accent: #d4af37; 
            --accent-dim: #8a701e;
            --text-main: #ffffff;
            --text-sec: #8aaec4;
            --success: #00e676; 
            --danger: #ff5252;
            --warning: #ffab00;
            --telegram: #229ED9;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(180deg, #001220 0%, #000000 100%); 
            margin: 0; padding: 15px; 
            color: var(--text-main);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px; /* Increased padding for sticky banner */
            user-select: none;
        }

        /* HEADER & UI */
        .header { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; margin-top: 10px; position: relative; }
        .logo-img { width: 140px; height: auto; display: block; filter: drop-shadow(0 0 10px rgba(212,175,55,0.3)); }
        
        .privacy-toggle {
            position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; transition: 0.3s;
        }

        body.privacy-active .sensitive { color: transparent !important; text-shadow: 0 0 8px rgba(255,255,255,0.5); pointer-events: none; }
        body.privacy-active input.sensitive { text-shadow: 0 0 8px rgba(255,255,255,0.5); color: transparent; }

        /* TABS */
        .tabs { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .tab-btn { flex: 0 0 auto; padding: 10px 15px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; font-size: 12px; cursor: pointer; border-radius: 8px; transition: all 0.3s; }
        .tab-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(212,175,55,0.4); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card { background-color: var(--bg-card); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); margin-bottom: 25px; border: 1px solid rgba(212, 175, 55, 0.15); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 8px; }

        /* SCENARIO TABS */
        .scenario-tabs { display: flex; background: #000; border-radius: 10px; padding: 2px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .scen-tab { flex: 1; text-align: center; padding: 10px 0; font-size: 12px; font-weight: bold; color: #666; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .scen-tab.active { background: var(--accent); color: #000; box-shadow: 0 0 10px rgba(212,175,55,0.3); }

        /* MODE SWITCHER */
        .mode-switch-container { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 3px; display: flex; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .mode-btn { flex: 1; padding: 8px; text-align: center; font-size: 11px; font-weight: bold; border-radius: 8px; cursor: pointer; color: #888; transition: 0.3s; }
        .mode-btn.active { background: var(--accent); color: #000; box-shadow: 0 2px 10px rgba(212,175,55,0.2); }

        /* INPUTS */
        .chart-controls { display: flex; gap: 5px; }
        .chart-btn { background: rgba(255,255,255,0.1); border: none; color: var(--text-sec); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .chart-btn.active { background: var(--accent); color: #000; }

        .preset-container { display: flex; gap: 8px; margin-bottom: 15px; justify-content: space-between; }
        .preset-btn { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 8px 0; border-radius: 8px; font-size: 10px; cursor: pointer; text-align: center; transition: 0.2s; }
        .preset-btn:active { background: var(--accent); color: #000; border-color: var(--accent); }

        .stepper-container { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 5px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .step-btn { background: linear-gradient(145deg, #222, #111); border: 1px solid var(--accent-dim); color: var(--accent); width: 45px; height: 45px; border-radius: 10px; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s; user-select: none; }
        .step-display { flex: 1; text-align: center; font-family: 'Roboto Mono', monospace; font-size: 18px; font-weight: 700; color: #fff; display: flex; flex-direction: column; align-items: center; }
        .step-display input { background: transparent; border: none; color: #fff; text-align: center; font-size: 18px; font-weight: 700; width: 100%; outline: none; -moz-appearance: textfield; }
        .step-label { font-size: 10px; color: var(--text-sec); text-transform: uppercase; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; }

        /* RESULTS & BOXES */
        .results-box { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .res-value-main { font-size: 28px; font-weight: 800; color: #fff; margin: 10px 0; letter-spacing: 1px; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; text-align: left; }
        .res-item-small { font-size: 11px; color: var(--text-sec); }
        .res-val-small { font-size: 14px; font-weight: 700; color: #fff; }
        
        .verdict-box { margin-top: 15px; background: rgba(212,175,55,0.15); border: 1px solid var(--accent); border-radius: 10px; padding: 15px; text-align: left; }
        .verdict-title { font-size: 11px; font-weight: bold; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .verdict-text { font-size: 13px; color: #fff; line-height: 1.4; }

        .text-green { color: var(--success) !important; }
        .text-red { color: var(--danger) !important; }
        .text-gold { color: var(--accent) !important; }

        .switch-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        .chart-wrapper { position: relative; height: 220px; width: 100%; margin-top:20px; }
        .btn-unified { width: 100%; padding: 14px; border-radius: 10px; font-size: 13px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box; text-decoration: none; text-transform: uppercase; margin-top:15px; }
        .crash-btn { background: rgba(255, 82, 82, 0.1); border: 1px solid var(--danger); color: #ff8a80; }
        .crash-btn.active { background: var(--danger); color: #fff; }
        .partner-btn-gold { background: linear-gradient(45deg, #111, #222); border: 1px solid var(--accent); color: var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        /* STICKY TIP BANNER */
        .sticky-tip {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 420px;
            background: rgba(18, 18, 18, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 9999;
            text-decoration: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .sticky-tip:active { transform: translateX(-50%) scale(0.98); }
        .tip-content { display: flex; flex-direction: column; gap: 2px; }
        .tip-title { font-size: 11px; color: #aaa; text-transform: uppercase; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .tip-text { font-size: 13px; color: #fff; font-weight: 600; }
        .tip-arrow { color: var(--accent); font-size: 18px; }

        .reset-link { display: block; text-align: center; margin-top: 20px; color: #555; font-size: 11px; text-decoration: underline; cursor: pointer; }
        .disclaimer { margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 10px; color: #666; text-align: justify; line-height: 1.4; border: 1px solid rgba(255,255,255,0.05); }
        .tax-select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 6px; padding: 5px; font-size: 14px; width: 100%; margin-bottom: 10px; }

        /* ARENA GRID */
        .arena-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; background: rgba(255,255,255,0.02); padding: 10px; border-radius: 10px; }
        .arena-check { display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; color: #666; transition: 0.2s; }
        .arena-check.active { color: #fff; border-color: var(--accent); background: rgba(212, 175, 55, 0.1); }
        .arena-check input { display: none; }
        .arena-check span { margin-left: 5px; }

        /* BARS */
        .eff-container { margin-top: 15px; background: rgba(255,255,255,0.02); border-radius: 8px; padding: 10px; }
        .eff-row { margin-bottom: 12px; }
        .eff-label { font-size: 10px; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .eff-bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; display: flex; }
        .eff-bar-inv { height: 100%; background: #444; }
        .eff-bar-gain { height: 100%; }

    </style>
</head>
<body>

    <div class="header">
        <img src="1000072083.jpg" alt="SELECTA ITALIA" class="logo-img">
        <div class="privacy-toggle" onclick="togglePrivacy()">üëÅÔ∏è</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('pac')">PAC</button>
        <button class="tab-btn" onclick="openTab('rendita')">Rendita</button>
        <button class="tab-btn" onclick="openTab('fisco')">Fisco</button>
        <button class="tab-btn" onclick="openTab('tools')">Tools</button>
        <button class="tab-btn" onclick="openTab('confronto')">Report</button>
    </div>

    <div id="pac" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üìà PAC & Investimenti</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('pac', 'line', event)">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('pac', 'pie', event)">Torta</button>
                </div>
            </div>

            <div class="scenario-tabs">
                <div class="scen-tab active" id="tab-pac-A" onclick="switchScenario('PAC','A')">PAC A</div>
                <div class="scen-tab" id="tab-pac-B" onclick="switchScenario('PAC','B')">PAC B</div>
                <div class="scen-tab" id="tab-pac-C" onclick="switchScenario('PAC','C')">PAC C</div>
            </div>

            <div class="mode-switch-container">
                <div class="mode-btn active" id="mode-proj" onclick="setPacMode('projection')">Proiezione</div>
                <div class="mode-btn" id="mode-target" onclick="setPacMode('target')">Obiettivo üéØ</div>
            </div>

            <div class="preset-container">
                <div class="preset-btn" onclick="applyPreset(4)">Prudente (4%)</div>
                <div class="preset-btn" onclick="applyPreset(8)">Bilanciato (8%)</div>
                <div class="preset-btn" onclick="applyPreset(12)">Aggressivo (12%)</div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-initial', -500)">-</div>
                <div class="step-display"><span class="step-label">Capitale Iniziale (‚Ç¨)</span><input type="number" inputmode="decimal" id="pac-initial" value="5000" class="sensitive" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-initial', 500)">+</div>
            </div>
            
            <div class="stepper-container" id="grp-monthly">
                <div class="step-btn" onclick="changeVal('pac-monthly', -50)">-</div>
                <div class="step-display"><span class="step-label">Versamento Mensile (‚Ç¨)</span><input type="number" inputmode="decimal" id="pac-monthly" value="400" class="sensitive" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-monthly', 50)">+</div>
            </div>

            <div class="stepper-container" id="grp-target" style="display:none; border-color:var(--accent);">
                <div class="step-btn" onclick="changeVal('pac-target-val', -5000)">-</div>
                <div class="step-display"><span class="step-label text-gold">Obiettivo Finale (‚Ç¨)</span><input type="number" inputmode="decimal" id="pac-target-val" value="100000" class="sensitive" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-target-val', 5000)">+</div>
            </div>

            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-years', -1)">-</div>
                <div class="step-display"><span class="step-label">Durata (Anni)</span><input type="number" inputmode="decimal" id="pac-years" value="15" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-years', 1)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-rate', -0.5)">-</div>
                <div class="step-display"><span class="step-label">Rendimento (%)</span><input type="number" inputmode="decimal" id="pac-rate" value="8" step="0.5" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-rate', 0.5)">+</div>
            </div>
            <div class="stepper-container">
                <div class="step-btn" onclick="changeVal('pac-fees', -50)">-</div>
                <div class="step-display"><span class="step-label">Costi d'Ingresso (‚Ç¨)</span><input type="number" inputmode="decimal" id="pac-fees" value="0" class="sensitive" onchange="calculatePAC()"></div>
                <div class="step-btn" onclick="changeVal('pac-fees', 50)">+</div>
            </div>

            <div class="switch-container">
                <div style="font-size:12px; color:#aaa;">Calcola Inflazione</div>
                <label class="switch"><input type="checkbox" id="pac-inflation" onchange="calculatePAC()"><span class="slider"></span></label>
            </div>

            <div class="results-box">
                <div style="font-size:11px; color:var(--text-sec); letter-spacing:1px;" id="res-pac-label">MONTANTE FINALE LORDO</div>
                <div class="res-value-main sensitive"><span id="res-pac-gross">‚Ç¨ 0</span></div>
                <div class="res-grid" style="border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    <div><div class="res-item-small" id="lbl-invested">Totale Versato</div><div class="res-val-small sensitive" id="res-pac-invested">‚Ç¨ 0</div></div>
                    <div><div class="res-item-small" id="lbl-gain">Guadagno</div><div class="res-val-small text-green sensitive" id="res-pac-gain">‚Ç¨ 0</div></div>
                </div>
                
                <div class="verdict-box" id="pac-verdict-box" style="display:none;">
                    <div class="verdict-title">üÜö Analisi Strategica</div>
                    <div class="verdict-text" id="pac-verdict-text">...</div>
                </div>

                <div class="btn-unified crash-btn" id="btn-crash" onclick="toggleCrash()">üí• Simula Crollo Mercati (-35%)</div>
            </div>
            <div class="chart-wrapper"><canvas id="pacChart"></canvas></div>
        </div>
    </div>

    <div id="rendita" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üè† Rendita Immobiliare</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('ren', 'line', event)">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('ren', 'pie', event)">Torta</button>
                </div>
            </div>

            <div class="scenario-tabs">
                <div class="scen-tab active" id="tab-ren-A" onclick="switchScenario('REN','A')">REN A</div>
                <div class="scen-tab" id="tab-ren-B" onclick="switchScenario('REN','B')">REN B</div>
                <div class="scen-tab" id="tab-ren-C" onclick="switchScenario('REN','C')">REN C</div>
            </div>

            <div class="stepper-container"><div class="step-btn" onclick="changeVal('ren-asset-val', -5000)">-</div><div class="step-display"><span class="step-label">Valore Asset (‚Ç¨)</span><input type="number" inputmode="decimal" id="ren-asset-val" value="200000" class="sensitive" onchange="calculateRen()"></div><div class="step-btn" onclick="changeVal('ren-asset-val', 5000)">+</div></div>
            <div class="stepper-container"><div class="step-btn" onclick="changeVal('ren-invested', -5000)">-</div><div class="step-display"><span class="step-label">Capitale Versato (‚Ç¨)</span><input type="number" inputmode="decimal" id="ren-invested" value="150000" class="sensitive" onchange="calculateRen()"></div><div class="step-btn" onclick="changeVal('ren-invested', 5000)">+</div></div>
            <div class="stepper-container"><div class="step-btn" onclick="changeVal('ren-monthly', -50)">-</div><div class="step-display"><span class="step-label">Affitto Netto Mensile (‚Ç¨)</span><input type="number" inputmode="decimal" id="ren-monthly" value="800" class="sensitive" onchange="calculateRen()"></div><div class="step-btn" onclick="changeVal('ren-monthly', 50)">+</div></div>
            <div class="stepper-container"><div class="step-btn" onclick="changeVal('ren-growth', -0.5)">-</div><div class="step-display"><span class="step-label">Rivalutazione Asset (%)</span><input type="number" inputmode="decimal" id="ren-growth" value="2" step="0.5" onchange="calculateRen()"></div><div class="step-btn" onclick="changeVal('ren-growth', 0.5)">+</div></div>
             <div class="stepper-container"><div class="step-btn" onclick="changeVal('ren-years', -1)">-</div><div class="step-display"><span class="step-label">Anni Proiezione</span><input type="number" inputmode="decimal" id="ren-years" value="15" onchange="calculateRen()"></div><div class="step-btn" onclick="changeVal('ren-years', 1)">+</div></div>
            <div class="switch-container"><div style="font-size:12px; color:#aaa;">Calcola Inflazione</div><label class="switch"><input type="checkbox" id="ren-inflation" onchange="calculateRen()"><span class="slider"></span></label></div>
            <div class="results-box">
                <div style="font-size:11px; color:var(--text-sec);">RICCHEZZA TOTALE GENERATA</div><div class="res-value-main sensitive" id="res-ren-total-val">‚Ç¨ 0</div>
                <div class="res-grid"><div><div class="res-item-small">Valore Asset Finale</div><div class="res-val-small sensitive" id="res-ren-final-asset">‚Ç¨ 0</div></div><div><div class="res-item-small">Affitti Incassati</div><div class="res-val-small text-green sensitive" id="res-ren-total-cash">‚Ç¨ 0</div></div></div>
                <div class="res-grid"><div><div class="res-item-small">Investito Iniziale</div><div class="res-val-small sensitive" id="res-ren-invested-disp">‚Ç¨ 0</div></div><div><div class="res-item-small">ROI Totale</div><div class="res-val-small text-gold sensitive" id="res-ren-roi">0%</div></div></div>
            </div>
            <div class="chart-wrapper"><canvas id="renChart"></canvas></div>
        </div>
    </div>

    <div id="fisco" class="tab-content">
         <div class="card"><div class="card-title">‚öñÔ∏è Calcolatore Netto</div><select id="fisco-type" class="tax-select" onchange="calculateFisco()"><option value="26">Azioni / ETF / Crypto (26%)</option><option value="12.5">Titoli di Stato / Bond (12.5%)</option></select><div class="stepper-container"><div class="step-btn" onclick="changeVal('fisco-gain', -100)">-</div><div class="step-display"><span class="step-label">Guadagno Lordo (‚Ç¨)</span><input type="number" inputmode="decimal" id="fisco-gain" value="1000" class="sensitive" onchange="calculateFisco()"></div><div class="step-btn" onclick="changeVal('fisco-gain', 100)">+</div></div><div class="stepper-container"><div class="step-btn" onclick="changeVal('fisco-capital', -1000)">-</div><div class="step-display"><span class="step-label">Capitale Investito Totale (‚Ç¨)</span><input type="number" inputmode="decimal" id="fisco-capital" value="10000" class="sensitive" onchange="calculateFisco()"></div><div class="step-btn" onclick="changeVal('fisco-capital', 1000)">+</div></div><div class="switch-container"><div style="font-size:12px; color:#aaa;">Applica Bollo (0.2% IVAFE/anno)</div><label class="switch"><input type="checkbox" id="fisco-bollo" onchange="calculateFisco()"><span class="slider"></span></label></div><div class="results-box"><div class="res-item-small">NETTO IN TASCA</div><div class="res-value-main text-green sensitive" id="res-fisco-net">‚Ç¨ 0</div><div class="res-grid"><div><div class="res-item-small">Tasse (Capital Gain)</div><div class="res-val-small text-red sensitive" id="res-fisco-tax">‚Ç¨ 0</div></div><div><div class="res-item-small">Bollo (Stima 1 anno)</div><div class="res-val-small text-warning sensitive" id="res-fisco-stamp">‚Ç¨ 0</div></div></div></div></div>
    </div>

    <div id="tools" class="tab-content">
        <div class="card">
            <div class="card-title">üèñÔ∏è F.I.R.E. Countdown</div>
            <div class="stepper-container"><div class="step-btn" onclick="changeFire('fire-expenses', -50)">-</div><div class="step-display"><span class="step-label">Spese Mensili (‚Ç¨)</span><input type="number" inputmode="decimal" id="fire-expenses" value="1500" class="sensitive" onchange="calcFire()"></div><div class="step-btn" onclick="changeFire('fire-expenses', 50)">+</div></div>
            <div class="stepper-container"><div class="step-btn" onclick="changeFire('fire-current', -1000)">-</div><div class="step-display"><span class="step-label">Capitale Attuale (‚Ç¨)</span><input type="number" inputmode="decimal" id="fire-current" value="10000" class="sensitive" onchange="calcFire()"></div><div class="step-btn" onclick="changeFire('fire-current', 1000)">+</div></div>
            <div class="stepper-container"><div class="step-btn" onclick="changeFire('fire-savings', -50)">-</div><div class="step-display"><span class="step-label">Risparmio Mensile (‚Ç¨)</span><input type="number" inputmode="decimal" id="fire-savings" value="500" class="sensitive" onchange="calcFire()"></div><div class="step-btn" onclick="changeFire('fire-savings', 50)">+</div></div>
            <div class="results-box">
                <div class="res-item-small">Obiettivo (25x Spese): <span id="fire-goal-val" class="sensitive">‚Ç¨ 450.000</span></div>
                <div class="res-value-main" id="fire-time" style="font-size:22px; color:var(--accent);">Calcolo...</div>
                <div style="font-size:10px; color:#aaa; margin-top:5px;" id="fire-breakdown"></div>
            </div>
        </div>
        <div class="card"><div class="card-title">‚è≥ Backtest Reale (10 Anni)</div><p style="font-size:11px; color:#aaa;">Se avessi investito nel 2016...</p><select id="backtest-asset" class="tax-select" onchange="calcBacktest()"><option value="sp500">üá∫üá∏ S&P 500 (+220%)</option><option value="btc">‚Çø Bitcoin (+5000%)</option><option value="gold">ü•á Oro (+90%)</option></select><input type="number" inputmode="decimal" id="backtest-amount" value="1000" class="tax-select sensitive" style="text-align:center; font-weight:bold; color:#fff;" onchange="calcBacktest()"><div class="results-box"><div class="res-item-small">Oggi avresti:</div><div class="res-value-main sensitive" id="backtest-result">‚Ç¨ 3.200</div></div></div>
    </div>

    <div id="confronto" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üèÜ SUPER ARENA</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartMode('arena', 'line', event)">Linea</button>
                    <button class="chart-btn" onclick="setChartMode('arena', 'pie', event)">Torta</button>
                </div>
            </div>
            
            <p style="font-size:11px; color:#aaa; text-align:center; margin-bottom:15px;">Seleziona gli scenari da confrontare:</p>
            
            <div class="arena-selector">
                <label class="arena-check" id="chk-pac-A"><input type="checkbox" onchange="toggleArena('PAC','A')" checked><span>PAC A</span></label>
                <label class="arena-check" id="chk-pac-B"><input type="checkbox" onchange="toggleArena('PAC','B')"><span>PAC B</span></label>
                <label class="arena-check" id="chk-pac-C"><input type="checkbox" onchange="toggleArena('PAC','C')"><span>PAC C</span></label>
                <label class="arena-check" id="chk-ren-A"><input type="checkbox" onchange="toggleArena('REN','A')" checked><span>REN A</span></label>
                <label class="arena-check" id="chk-ren-B"><input type="checkbox" onchange="toggleArena('REN','B')"><span>REN B</span></label>
                <label class="arena-check" id="chk-ren-C"><input type="checkbox" onchange="toggleArena('REN','C')"><span>REN C</span></label>
            </div>

            <div class="chart-wrapper" style="height:250px;">
                <canvas id="arenaChart"></canvas>
            </div>

            <div style="background:rgba(0,230,118,0.1); padding:15px; border-radius:10px; margin-top:20px; text-align:center; margin-bottom:20px;">
                <div class="res-item-small">VINCITORE TRA I SELEZIONATI</div>
                <div id="comp-winner-text" style="font-size:18px; font-weight:800; color:var(--success); margin-top:5px;">---</div>
            </div>
            <div class="eff-container" id="arena-bars"></div>
        </div>
    </div>

    <hr>
    
    <a href="https://t.me/selectaitalia" class="btn-unified partner-btn-gold">üíé Unisciti al Canale @selectaitalia</a>
    <div class="reset-link" onclick="clearData()">‚ö†Ô∏è Reset Dati</div>
    <div class="disclaimer"><strong>DISCLAIMER:</strong> Calcoli indicativi. Non costituiscono consulenza finanziaria.<br>¬© Selecta Italia - v10.5 Final</div>

    <a href="https://refnocode.trade.re/pcbrl1pv" target="_blank" class="sticky-tip">
        <div class="tip-content">
            <div class="tip-title">üí° CONSIGLIO DEL GIORNO</div>
            <div class="tip-text">Inizia il tuo PAC automatico su Trade Republic</div>
        </div>
        <div class="tip-arrow">‚ûî</div>
    </a>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let pacChart = null; let renChart = null; let arenaChart = null;
        let pacMode = 'line'; let renMode = 'line'; let arenaMode = 'line';
        let pacCalcMode = 'projection'; 
        let crashMode = false;
        let isPrivacy = false;
        const fmt = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
        
        let activePacScenario = 'A';
        let activeRenScenario = 'A';
        
        let scenarios = JSON.parse(localStorage.getItem('selecta_v10_3')) || {
            PAC: { A: {}, B: {}, C: {} },
            REN: { A: {}, B: {}, C: {} },
            arenaSelection: ['PAC-A', 'REN-A']
        };

        function initApp() {
            try {
                document.querySelectorAll('.arena-check input').forEach(el => el.checked = false);
                scenarios.arenaSelection.forEach(id => {
                    let parts = id.split('-');
                    let el = document.querySelector(`#chk-${parts[0].toLowerCase()}-${parts[1]} input`);
                    if(el) el.checked = true;
                });
                updateArenaUI();
                switchScenario('PAC', 'A', true);
                switchScenario('REN', 'A', true);
                calculateAll();
            } catch (e) {
                console.error("Init error:", e);
            }
        }

        function switchScenario(type, id, isInit=false) {
            triggerHaptic();
            if(type === 'PAC') activePacScenario = id;
            if(type === 'REN') activeRenScenario = id;
            document.querySelectorAll(`#tab-${type.toLowerCase()}-A, #tab-${type.toLowerCase()}-B, #tab-${type.toLowerCase()}-C`).forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${type.toLowerCase()}-${id}`).classList.add('active');
            let data = scenarios[type][id];
            if(type === 'PAC') {
                ['pac-initial', 'pac-monthly', 'pac-years', 'pac-rate', 'pac-fees', 'pac-inflation', 'pac-target-val'].forEach(k => {
                   if(data[k] !== undefined) { let el = document.getElementById(k); if(el) el.type==='checkbox' ? el.checked=data[k] : el.value=data[k]; }
                });
                setPacMode('projection'); 
            }
            if(type === 'REN') {
                 ['ren-asset-val', 'ren-invested', 'ren-monthly', 'ren-growth', 'ren-years', 'ren-inflation'].forEach(k => {
                   if(data[k] !== undefined) { let el = document.getElementById(k); if(el) el.type==='checkbox' ? el.checked=data[k] : el.value=data[k]; }
                });
            }
            if(!isInit) {
                if(type === 'PAC') calculatePAC();
                if(type === 'REN') calculateRen();
            }
        }

        function autoSave(type) {
            let id = (type === 'PAC') ? activePacScenario : activeRenScenario;
            let inputs = (type === 'PAC') ? ['pac-initial', 'pac-monthly', 'pac-years', 'pac-rate', 'pac-fees', 'pac-inflation', 'pac-target-val'] : ['ren-asset-val', 'ren-invested', 'ren-monthly', 'ren-growth', 'ren-years', 'ren-inflation'];
            let data = {};
            inputs.forEach(k => { let el = document.getElementById(k); if(el) data[k] = el.type==='checkbox' ? el.checked : el.value; });
            scenarios[type][id] = data;
            let sel = [];
            document.querySelectorAll('.arena-check input:checked').forEach(el => { let parts = el.parentElement.id.split('-'); sel.push(`${parts[1].toUpperCase()}-${parts[2]}`); });
            scenarios.arenaSelection = sel;
            localStorage.setItem('selecta_v10_3', JSON.stringify(scenarios));
        }

        function triggerHaptic() { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }
        function togglePrivacy() { triggerHaptic(); isPrivacy = !isPrivacy; document.body.classList.toggle('privacy-active'); }
        function changeVal(id, amount) { triggerHaptic(); const input = document.getElementById(id); let val = parseFloat(input.value) || 0; let newVal = val + amount; if(newVal < 0) newVal = 0; if(amount % 1 !== 0) newVal = parseFloat(newVal.toFixed(1)); input.value = newVal; calculateAll(); }
        
        // --- FIXED PRESET FUNCTION ---
        function applyPreset(val) { triggerHaptic(); document.getElementById('pac-rate').value = val; calculatePAC(); }

        function openTab(id) { triggerHaptic(); document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); if(id === 'confronto') setTimeout(updateArena, 100); }
        function setChartMode(chart, mode, event) { triggerHaptic(); if(chart === 'pac') { pacMode = mode; calculatePAC(); } if(chart === 'ren') { renMode = mode; calculateRen(); } if(chart === 'arena') { arenaMode = mode; updateArena(); } let parent = event.currentTarget.parentElement; parent.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active')); event.currentTarget.classList.add('active'); }
        function setPacMode(mode) { triggerHaptic(); pacCalcMode = mode; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById(mode === 'projection' ? 'mode-proj' : 'mode-target').classList.add('active'); document.getElementById('grp-monthly').style.display = mode === 'projection' ? 'flex' : 'none'; document.getElementById('grp-target').style.display = mode === 'target' ? 'flex' : 'none'; document.getElementById('res-pac-label').innerText = mode === 'projection' ? "MONTANTE FINALE LORDO" : "VERSAMENTO MENSILE NECESSARIO"; document.getElementById('lbl-gain').innerText = mode === 'projection' ? "Guadagno" : "Interessi Totali"; calculatePAC(); }
        function calculateAll() { calculatePAC(); calculateRen(); calculateFisco(); calcFire(); calcBacktest(); autoSave('PAC'); updateArena(); }

        function calculatePAC() {
            autoSave('PAC');
            let P = parseFloat(document.getElementById('pac-initial').value) || 0;
            let PMT = parseFloat(document.getElementById('pac-monthly').value) || 0;
            let years = parseFloat(document.getElementById('pac-years').value) || 1;
            let rate = (parseFloat(document.getElementById('pac-rate').value) || 0) / 100;
            let costs = parseFloat(document.getElementById('pac-fees').value) || 0;
            let useInflation = document.getElementById('pac-inflation').checked;
            
            let months = years * 12; let monthlyRate = rate / 12;
            let currentTotal = P - costs; let currentInvested = P;
            let labels = []; let dataTot = []; let dataInv = [];
            let crashMonth = Math.floor(months / 2);

            let totalCapitalForLump = P + (PMT * months); 
            let lumpSumSim = (totalCapitalForLump - costs) * Math.pow(1 + monthlyRate, months);

            if (pacCalcMode === 'projection') {
                if(PMT === 0 && P > 0) document.getElementById('lbl-invested').innerText = "Lump Sum (Unico)";
                else document.getElementById('lbl-invested').innerText = "Totale Versato";

                for(let i=1; i<=months; i++){
                    currentTotal = (currentTotal + PMT) * (1 + monthlyRate);
                    currentInvested += PMT;
                    if(crashMode && i === crashMonth) currentTotal = currentTotal * 0.65; 
                    labels.push(i); dataTot.push(currentTotal); dataInv.push(currentInvested);
                }
                
                let grossFinal = currentTotal;
                if(useInflation) { grossFinal /= Math.pow(1.02, years); lumpSumSim /= Math.pow(1.02, years); }
                let gainTotal = grossFinal - currentInvested;

                document.getElementById('res-pac-gross').innerText = fmt.format(grossFinal);
                document.getElementById('res-pac-invested').innerText = fmt.format(currentInvested);
                document.getElementById('res-pac-gain').innerText = fmt.format(gainTotal);
                setDynamicColor('res-pac-gain', gainTotal, 0);

                if (pacMode === 'pie') updateChart('pacChart', 'pie', ['Capitale', 'Guadagno'], [currentInvested, gainTotal], null, ['#1565c0', '#00e676']);
                else updateChart('pacChart', 'line', labels, dataTot, dataInv, ['#00e676', '#1565c0'], true);

                let verdictBox = document.getElementById('pac-verdict-box');
                let verdictText = document.getElementById('pac-verdict-text');
                if(PMT > 0 && P > 0) {
                    verdictBox.style.display = 'block';
                    let diff = lumpSumSim - grossFinal;
                    if(diff > 0) verdictText.innerHTML = `üí° <strong>Verdetto:</strong> Se avessi tutto il capitale (${fmt.format(totalCapitalForLump)}) subito, il Lump Sum vincerebbe di <span class="text-green">${fmt.format(diff)}</span>.`;
                    else verdictText.innerHTML = `üí° <strong>Verdetto:</strong> Con i flussi attuali, il PAC √® la scelta ottimale.`;
                } else {
                    verdictBox.style.display = 'none';
                }

            } else {
                let Target = parseFloat(document.getElementById('pac-target-val').value) || 0;
                let FV_Initial = (P - costs) * Math.pow(1 + monthlyRate, months);
                let Remainder = Target - FV_Initial;
                let calculatedMonthly = 0;
                if (Remainder > 0) { let GeometricSeries = (Math.pow(1 + monthlyRate, months) - 1) / monthlyRate; calculatedMonthly = Remainder / GeometricSeries; }
                PMT = calculatedMonthly; currentTotal = P - costs; currentInvested = P;
                for(let i=1; i<=months; i++){ currentTotal = (currentTotal + PMT) * (1 + monthlyRate); currentInvested += PMT; labels.push(i); dataTot.push(currentTotal); dataInv.push(currentInvested); }
                document.getElementById('res-pac-gross').innerText = fmt.format(calculatedMonthly) + " / mese";
                document.getElementById('res-pac-invested').innerText = fmt.format(currentInvested);
                document.getElementById('res-pac-gain').innerText = fmt.format(currentTotal - currentInvested);
                if (pacMode === 'pie') updateChart('pacChart', 'pie', ['Capitale', 'Interessi'], [currentInvested, currentTotal - currentInvested], null, ['#1565c0', '#00e676']);
                else updateChart('pacChart', 'line', labels, dataTot, dataInv, ['#00e676', '#1565c0'], true);
                document.getElementById('pac-verdict-box').style.display = 'none';
            }
            updateArena();
        }

        // --- UPDATED RENT CHART LOGIC ---
        function calculateRen() {
            autoSave('REN');
            let Asset = parseFloat(document.getElementById('ren-asset-val').value)||0;
            let Invested = parseFloat(document.getElementById('ren-invested').value)||0;
            let Rent = parseFloat(document.getElementById('ren-monthly').value)||0;
            let years = parseFloat(document.getElementById('ren-years').value)||1;
            let growth = (parseFloat(document.getElementById('ren-growth').value)||0) / 100;
            let useInflation = document.getElementById('ren-inflation').checked;
            
            let months = years * 12; let currentAsset = Asset; let cashTotal = 0; let monthlyGrowth = growth / 12;
            let labels = []; let dataTotal = []; let dataCash = [];
            
            for(let i=1; i<=months; i++){ 
                currentAsset = currentAsset * (1 + monthlyGrowth); 
                cashTotal += Rent; 
                labels.push(i); 
                dataTotal.push(currentAsset + cashTotal);
                dataCash.push(cashTotal); 
            }
            let total = currentAsset + cashTotal;
            if(useInflation) total = total / Math.pow(1.02, years);
            let roi = 0; if (Invested > 0) roi = ((total - Invested) / Invested) * 100;
            
            document.getElementById('res-ren-total-val').innerText = fmt.format(total);
            document.getElementById('res-ren-final-asset').innerText = fmt.format(currentAsset);
            document.getElementById('res-ren-total-cash').innerText = fmt.format(cashTotal);
            document.getElementById('res-ren-invested-disp').innerText = fmt.format(Invested);
            document.getElementById('res-ren-roi').innerText = roi.toFixed(1) + "%";
            setDynamicColor('res-ren-total-val', total - Invested, 0); setDynamicColor('res-ren-roi', roi, 0);
            
            let assetGain = currentAsset - Invested;
            if (assetGain < 0) assetGain = 0; 
            
            if (renMode === 'pie') {
                // NEW PIE CHART: 3 SLICES
                updateChart('renChart', 'pie', 
                    ['Capitale Versato', 'Rivalutazione Asset', 'Affitti Incassati'], 
                    [Invested, assetGain, cashTotal], 
                    null, 
                    ['#1565c0', '#d4af37', '#00e676'] // Blue, Gold, Green
                );
            }
            else updateChart('renChart', 'line', labels, dataTotal, dataCash, ['#d4af37', '#ffab00'], true, "Solo Affitti");
        }

        function calcFire() {
            try {
                let exp = parseFloat(document.getElementById('fire-expenses').value) || 0;
                let cur = parseFloat(document.getElementById('fire-current').value) || 0;
                let sav = parseFloat(document.getElementById('fire-savings').value) || 0;
                let rate = 0.07 / 12; // 7% media
                let goal = exp * 12 * 25; // Rule of 25

                document.getElementById('fire-goal-val').innerText = fmt.format(goal);

                if (cur >= goal) {
                    document.getElementById('fire-time').innerText = "SIAMO LIBERI! ü•Ç";
                    document.getElementById('fire-breakdown').innerText = "Obiettivo gi√† raggiunto!";
                    return;
                }
                if (sav <= 0 && cur < goal) {
                     document.getElementById('fire-time').innerText = "Mai üê¢";
                     document.getElementById('fire-breakdown').innerText = "Aumenta il risparmio!";
                     return;
                }

                let months = 0;
                let tempCap = cur;
                while (tempCap < goal && months < 1200) { 
                    tempCap = (tempCap + sav) * (1 + rate);
                    months++;
                }

                if(months >= 1200) {
                     document.getElementById('fire-time').innerText = "> 100 Anni";
                } else {
                    let years = Math.floor(months / 12);
                    let remMonths = months % 12;
                    document.getElementById('fire-time').innerText = `${years} Anni e ${remMonths} Mesi`;
                }
                document.getElementById('fire-breakdown').innerText = `Stima con rendimento annuo 7%`;
            } catch (e) { console.error(e); }
        }
        
        function changeFire(id, amount) { triggerHaptic(); const input = document.getElementById(id); input.value = (parseFloat(input.value)||0) + amount; calcFire(); }

        // --- GRAPHICS ---
        function getGradient(ctx, color) { let gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, color); gradient.addColorStop(1, 'rgba(0,0,0,0)'); return gradient; }

        function updateChart(id, mode, labels, data1, data2, colors, useGradient=false, label2='Investito') {
            const canvas = document.getElementById(id);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            let instance = (id === 'pacChart') ? pacChart : renChart;
            if(instance) instance.destroy();
            let bg = colors[0]+'33'; if(useGradient) bg = getGradient(ctx, colors[0]);

            let config;
            if(mode === 'line') {
                let datasets = [
                    { label: 'Totale', data: data1, borderColor: colors[0], backgroundColor: bg, fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 6 }, 
                    ...(data2 ? [{ label: label2, data: data2, borderColor: colors[1], borderDash:[], pointRadius:0, borderWidth:2, fill:false }] : [])
                ];
                config = { type: 'line', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels:{color:'#ccc'} }, tooltip: { mode: 'index', intersect: false } }, scales: { x:{display:false}, y:{display:false} }, interaction: { intersect: false, mode: 'index' } } };
            } else {
                config = { type: 'doughnut', data: { labels: labels, datasets: [{ data: data1, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels:{color:'#fff'} } } } };
            }
            let newChart = new Chart(ctx, config);
            if(id === 'pacChart') pacChart = newChart; else renChart = newChart;
        }

        // --- ARENA ---
        function toggleArena(type, slot) { triggerHaptic(); updateArenaUI(); updateArena(); }
        function updateArenaUI() { document.querySelectorAll('.arena-check').forEach(lbl => { if(lbl.querySelector('input').checked) lbl.classList.add('active'); else lbl.classList.remove('active'); }); autoSave('PAC'); }

        function updateArena() {
            const canvas = document.getElementById('arenaChart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            
            let selected = [];
            document.querySelectorAll('.arena-check input:checked').forEach(el => { let parts = el.parentElement.id.split('-'); selected.push({ type: parts[1].toUpperCase(), slot: parts[2] }); });

            let datasets = [];
            let maxVal = 0; let winnerName = "Nessuno"; let winnerTot = 0; let winnerInv = 0;
            let globalMaxYears = 0;
            
            selected.forEach(s => { let d = scenarios[s.type][s.slot]; let y = parseFloat(d[s.type==='PAC'?'pac-years':'ren-years']) || 15; if(y > globalMaxYears) globalMaxYears = y; });

            let palette = { 'PAC-A': '#00e676', 'PAC-B': '#00bfa5', 'PAC-C': '#69f0ae', 'REN-A': '#d4af37', 'REN-B': '#ffab00', 'REN-C': '#ffd740' };

            selected.forEach(s => {
                let d = scenarios[s.type][s.slot];
                if(!d) return; 
                let dataPoints = []; let finalVal = 0; let totalInv = 0;

                if(s.type === 'PAC') {
                    let P = parseFloat(d['pac-initial'])||0; let PMT = parseFloat(d['pac-monthly'])||0; let r = (parseFloat(d['pac-rate'])||0)/100/12; let cost = parseFloat(d['pac-fees'])||0; let y = parseFloat(d['pac-years'])||15;
                    let cur = P - cost; totalInv = P;
                    for(let m=1; m<=globalMaxYears*12; m++) {
                        if(m <= y*12) { cur = (cur + PMT)*(1+r); totalInv += PMT; } else { cur = cur * (1+r); }
                        if(m%12===0) dataPoints.push(cur);
                    }
                    finalVal = cur;
                } else {
                    let P = parseFloat(d['ren-asset-val'])||0; let rent = parseFloat(d['ren-monthly'])||0; let g = (parseFloat(d['ren-growth'])||0)/100/12; let y = parseFloat(d['ren-years'])||15;
                    let cur = P; let cash = 0; totalInv = parseFloat(d['ren-invested'])||0;
                    for(let m=1; m<=globalMaxYears*12; m++) {
                        if(m <= y*12) { cur = cur*(1+g); cash += rent; } else { cur = cur*(1+g); cash += rent; }
                        if(m%12===0) dataPoints.push(cur + cash);
                    }
                    finalVal = cur + cash;
                }
                if(finalVal > maxVal) { maxVal = finalVal; winnerName = `${s.type} ${s.slot}`; winnerTot = finalVal; winnerInv = totalInv; }
                datasets.push({ label: `${s.type} ${s.slot}`, data: dataPoints, borderColor: palette[`${s.type}-${s.slot}`], borderWidth: 2, pointRadius: 0, tension: 0.3 });
            });

            let labels = []; for(let i=1; i<=globalMaxYears; i++) labels.push(i);
            
            if(arenaChart) arenaChart.destroy();

            if(arenaMode === 'line') {
                arenaChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels:{color:'#fff', boxWidth:10} } }, scales: { x:{display:true, ticks:{color:'#666'}}, y:{display:false} }, interaction: { intersect: false, mode: 'index' } } });
            } else {
                 let pieLabels = datasets.map(d => d.label); let pieData = datasets.map(d => d.data[d.data.length-1]); let pieColors = datasets.map(d => d.borderColor);
                 arenaChart = new Chart(ctx, { type: 'doughnut', data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: pieColors, borderWidth:0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels:{color:'#fff'} } } } });
            }

            document.getElementById('comp-winner-text').innerText = selected.length ? `${winnerName} üèÜ` : "Seleziona Scenari";
            let barContainer = document.getElementById('arena-bars');
            barContainer.innerHTML = '';
            if(selected.length > 0 && winnerName !== "Nessuno") {
                 let gain = winnerTot - winnerInv; if(gain<0) gain=0;
                 let pctInv = (winnerInv / winnerTot) * 100; let pctGain = 100 - pctInv;
                 barContainer.innerHTML = `<div class="eff-row"><div class="eff-label"><span>${winnerName} (Vincitore)</span><span class="sensitive">${fmt.format(winnerTot)}</span></div><div class="eff-bar-bg"><div class="eff-bar-inv" style="width:${pctInv}%"></div><div class="eff-bar-gain" style="background:${palette[winnerName.replace(' ','-')]}; width:${pctGain}%"></div></div><div style="font-size:9px; color:#666; margin-top:3px; display:flex; justify-content:space-between;"><span>Investito: ${fmt.format(winnerInv)}</span><span>Guadagno: ${fmt.format(gain)}</span></div></div>`;
            }
        }

        // OTHER CALCS
        function calculateFisco() { let type = parseFloat(document.getElementById('fisco-type').value); let gain = parseFloat(document.getElementById('fisco-gain').value)||0; let capital = parseFloat(document.getElementById('fisco-capital').value)||0; let useBollo = document.getElementById('fisco-bollo').checked; let tax = gain * (type / 100); let stamp = useBollo ? (capital * 0.002) : 0; let net = gain - tax - stamp; document.getElementById('res-fisco-net').innerText = fmt.format(net); document.getElementById('res-fisco-tax').innerText = fmt.format(tax); document.getElementById('res-fisco-stamp').innerText = fmt.format(stamp); }
        function calcBacktest() { let asset = document.getElementById('backtest-asset').value; let amount = parseFloat(document.getElementById('backtest-amount').value)||0; let mult = 1; if(asset === 'sp500') mult = 3.2; if(asset === 'btc') mult = 50; if(asset === 'gold') mult = 1.9; document.getElementById('backtest-result').innerText = fmt.format(amount * mult); }
        function toggleCrash() { triggerHaptic(); crashMode = !crashMode; let btn = document.getElementById('btn-crash'); if(crashMode) { btn.classList.add('active'); btn.innerText = "‚ö†Ô∏è CROLLO ATTIVO (-35%)"; } else { btn.classList.remove('active'); btn.innerText = "üí• Simula Crollo Mercati (-35%)"; } calculatePAC(); }
        function clearData() { if(confirm('Vuoi resettare i dati?')) { localStorage.removeItem('selecta_v10_3'); location.reload(); } }
        function setDynamicColor(elemId, value, threshold = 0) { const el = document.getElementById(elemId); if(value < threshold) { el.classList.remove('text-green', 'text-gold'); el.classList.add('text-red'); } else { el.classList.remove('text-red'); el.classList.add('text-green'); } }

        initApp();
    </script>
</body>
</html>
